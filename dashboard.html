<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Stock Submission</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="auth.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- Sync Status -->
    <div class="sync-status" id="syncStatus"></div>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Hamburger Button -->
    <button class="hamburger-btn" id="hamburgerBtn">
        <span></span>
        <span></span>
        <span></span>
    </button>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Navigation</h2>
            <button class="sidebar-close" id="sidebarClose">√ó</button>
        </div>
        <div class="sidebar-menu">
            <div class="sidebar-menu-item active" data-page="main" id="menuMain">
                <span>üìã</span>
                <span>Stock Entry</span>
            </div>
            <div class="sidebar-menu-item" data-page="export" id="menuExport">
                <span>üìä</span>
                <span>View Boxes</span>
            </div>
            <div class="sidebar-menu-item" id="menuUser" onclick="window.location.href='user.html'">
                <span>üë§</span>
                <span>User</span>
            </div>
            <div class="sidebar-menu-item" data-role="manager" onclick="window.location.href='admin.html'">
                <span>‚öôÔ∏è</span>
                <span>Admin Panel</span>
            </div>
            <div class="sidebar-menu-item" onclick="logout()">
                <span>üö™</span>
                <span>Sign Out</span>
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="app-wrapper">
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <div class="header-icon">üì¶</div>
                    <div>
                        <h1>Stock Submission</h1>
                        <!-- Dynamic Shift Status -->
                        <div class="header-subtitle" id="shiftStatusContainer">
                            <span id="shiftStatusText">Loading...</span>
                            <button class="btn btn-sm shift-header-btn" id="shiftHeaderBtn" style="display: none;">
                                Start Shift
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <!-- Main Page: Stock Entry -->
                <div class="page-content active" id="mainPage">
                    <div class="main-form" id="mainForm">
                        <div id="alertContainer"></div>
                        
                        <!-- Current Box Status Card -->
                        <div class="status-card">
                            <div class="status-card-content">
                                <h3 id="currentBoxId">No Active Box</h3>
                                <p id="currentBoxClient">Select a client to begin</p>
                                <div class="status-card-meta" id="jobsSummary"></div>
                            </div>
                            <button class="btn btn-danger" id="newBoxBtn" disabled>
                                Start New Box
                            </button>
                        </div>
                        
                        <!-- Form Fields -->
                        <div class="card">
                            <div class="form-group">
                                <label class="form-label" for="clientSelect">
                                    Client <span class="required">*</span>
                                </label>
                                <select id="clientSelect" class="form-select">
                                    <option value="">Select a client...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="vendorSelect">
                                    Vendor <span class="required">*</span>
                                </label>
                                <select id="vendorSelect" class="form-select">
                                    <option value="">Select a vendor...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="jobNumber">
                                    Job Number <span class="required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="jobNumber" 
                                    class="form-input" 
                                    placeholder="Enter job number"
                                >
                            </div>
                            
                            <!-- Individual Serial Entry -->
                            <div class="form-group individual-entry-area" id="individualEntry">
                                <label class="form-label">
                                    Serial Numbers <span class="required">*</span>
                                </label>
                                <div class="serial-inputs" id="serialInputs">
                                    <div class="serial-input-row">
                                        <input type="text" class="form-input serial-input" placeholder="Enter serial number">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 12px;">
                                    <button class="btn btn-primary" id="addSerialBtn">
                                        + Add Another Serial
                                    </button>
                                    <!-- Bulk Entry Toggle -->
                                    <div class="toggle-container" style="margin: 0;">
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="bulkToggle">
                                            <div class="toggle-slider"></div>
                                        </div>
                                        <label class="toggle-label" for="bulkToggle">Bulk Entry Mode</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bulk Serial Entry -->
                            <div class="bulk-entry-area" id="bulkEntry">
                                <div class="form-group">
                                    <label class="form-label" for="bulkSerials">
                                        Serial Numbers <span class="required">*</span>
                                        <span style="font-weight: 400; color: var(--text-muted);">(one per line)</span>
                                    </label>
                                    <textarea 
                                        id="bulkSerials" 
                                        class="form-textarea" 
                                        placeholder="Enter serial numbers, one per line..."
                                    ></textarea>
                                    <div style="margin-top: 12px;">
                                        <!-- Bulk Entry Toggle (for turning off) -->
                                        <div class="toggle-container" style="margin: 0;">
                                            <div class="toggle-switch">
                                                <input type="checkbox" id="bulkToggle2" checked>
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <label class="toggle-label" for="bulkToggle2">Bulk Entry Mode</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="button-group">
                                <button class="btn btn-primary" id="addJobBtn">
                                    Add Job to Box
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Export Page: View Boxes -->
                <div class="page-content" id="exportPage">
                    <div class="export-filters">
                        <h2>View Boxes</h2>
                        <div class="filter-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" for="filterAgent">
                                    Agent <span class="required">*</span>
                                </label>
                                <select id="filterAgent" class="form-select">
                                    <option value="">Select an agent...</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" for="filterExportClient">
                                    Client <span class="required">*</span>
                                </label>
                                <select id="filterExportClient" class="form-select">
                                    <option value="">Select a client...</option>
                                </select>
                            </div>
                        </div>
                        <div class="button-group" style="margin-top: 16px;">
                            <button class="btn btn-primary" id="loadBoxesBtn">Load Boxes</button>
                            <button class="btn btn-ghost" id="clearExportFiltersBtn">Clear Selection</button>
                        </div>
                    </div>
                    
                    <div class="export-results" id="exportResults">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <p>Select an agent and client, then click "Load Boxes"</p>
                        </div>
                    </div>
                    
                    <div class="export-box-selection hidden" id="exportBoxSelection"></div>
                    <div class="export-preview hidden" id="exportPreview"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Start Shift Modal -->
    <div class="modal" id="startShiftModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üöó Start New Shift</h3>
            </div>
            <div id="startShiftAlertContainer"></div>
            <form id="startShiftForm">
                <div class="form-group">
                    <label class="form-label" for="startShiftTime">
                        Start Time <span class="required">*</span>
                    </label>
                    <input 
                        type="datetime-local" 
                        id="startShiftTime" 
                        class="form-input" 
                        required
                    >
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                        Auto-filled with current time. Adjust if needed.
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label" for="startShiftKms">
                        Starting Kilometres (Odometer) <span class="required">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="startShiftKms" 
                        class="form-input" 
                        required 
                        placeholder="e.g., 45230"
                        min="0"
                    >
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" onclick="closeStartShiftModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Start Shift</button>
                </div>
            </form>
        </div>
    </div>

    <!-- End Shift Modal -->
    <div class="modal" id="endShiftModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üèÅ End Shift</h3>
            </div>
            <div id="endShiftAlertContainer"></div>
            <form id="endShiftForm">
                <div class="form-group">
                    <label class="form-label" for="endShiftTime">
                        End Time <span class="required">*</span>
                    </label>
                    <input 
                        type="datetime-local" 
                        id="endShiftTime" 
                        class="form-input" 
                        required
                    >
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                        Auto-filled with current time. Adjust if needed.
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label" for="endShiftKms">
                        Ending Kilometres (Odometer) <span class="required">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="endShiftKms" 
                        class="form-input" 
                        required 
                        placeholder="e.g., 45310"
                        min="0"
                    >
                </div>
                <div class="form-group">
                    <label class="form-label" for="extraJobs">
                        Extra Jobs (not logged in system)
                    </label>
                    <input 
                        type="number" 
                        id="extraJobs" 
                        class="form-input" 
                        placeholder="0"
                        min="0"
                        value="0"
                    >
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 4px;">
                        Jobs completed without serial logging (e.g., on-site repairs)
                    </p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" onclick="closeEndShiftModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">End Shift</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Stale Shift Recovery Modal -->
    <div class="modal" id="staleShiftModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Incomplete Shift Found</h3>
            </div>
            <div class="help-box" style="margin-bottom: 20px; border-left-color: var(--warning);">
                <p style="margin: 0;">
                    You have an unfinished shift from <strong id="staleShiftDate"></strong>. 
                    Please enter your end details to close it before starting a new shift.
                </p>
            </div>
            <div id="staleShiftAlertContainer"></div>
            <form id="staleShiftForm">
                <div class="form-group">
                    <label class="form-label">Shift Started</label>
                    <input 
                        type="text" 
                        id="staleShiftStartInfo" 
                        class="form-input" 
                        readonly 
                        style="background: var(--bg-primary); cursor: not-allowed;"
                    >
                </div>
                <div class="form-group">
                    <label class="form-label" for="staleShiftEndTime">
                        End Time <span class="required">*</span>
                    </label>
                    <input 
                        type="datetime-local" 
                        id="staleShiftEndTime" 
                        class="form-input" 
                        required
                    >
                </div>
                <div class="form-group">
                    <label class="form-label" for="staleShiftEndKms">
                        Ending Kilometres (Odometer) <span class="required">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="staleShiftEndKms" 
                        class="form-input" 
                        required 
                        placeholder="e.g., 45310"
                        min="0"
                    >
                </div>
                <div class="form-group">
                    <label class="form-label" for="staleExtraJobs">
                        Extra Jobs (not logged in system)
                    </label>
                    <input 
                        type="number" 
                        id="staleExtraJobs" 
                        class="form-input" 
                        placeholder="0"
                        min="0"
                        value="0"
                    >
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn-primary">Close Shift</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Shift Report Modal -->
    <div class="modal" id="shiftReportModal">
        <div class="modal-content" style="max-width: 560px;">
            <div class="modal-header">
                <h3>üìä Shift Report</h3>
            </div>
            <div class="shift-report-content" id="shiftReportContent">
                <!-- Report will be generated here -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="closeShiftReportModal()">Close</button>
                <button type="button" class="btn btn-secondary" onclick="copyShiftReport()">üìã Copy as Text</button>
                <button type="button" class="btn btn-primary" onclick="downloadShiftReportCSV()">üì• Download CSV</button>
            </div>
        </div>
    </div>

    <!-- Edit Job Modal -->
    <div class="modal" id="editJobModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Job</h3>
            </div>
            <div id="editJobAlertContainer"></div>
            <div class="form-group">
                <label class="form-label" for="editJobNumber">
                    Job Number <span class="required">*</span>
                </label>
                <input 
                    type="text" 
                    id="editJobNumber" 
                    class="form-input" 
                    placeholder="Enter job number"
                >
            </div>
            <div class="form-group">
                <label class="form-label" for="editVendorSelect">
                    Vendor <span class="required">*</span>
                </label>
                <select id="editVendorSelect" class="form-select">
                    <option value="">Loading vendors...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="editSerials">
                    Serial Numbers <span class="required">*</span>
                    <span style="font-weight: 400; color: var(--text-muted);">(one per line)</span>
                </label>
                <textarea 
                    id="editSerials" 
                    class="form-textarea" 
                    placeholder="Enter serial numbers, one per line..."
                    style="min-height: 200px;"
                ></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-ghost" onclick="closeEditJobModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveJobEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
let currentAgent, boxes = [], currentBox;
let currentUserRole = null;
let currentUserId = null;
let shiftsEnabled = false;
let activeShift = null;
let staleShift = null;
let lastShiftReport = null;
let editingJob = null;

        function getClientCode(client) {
            return client ? client.substring(0, 3).toUpperCase() : "OTH";
        }

        function formatBoxId(agent, client, boxNumber) {
            return `${agent}-${getClientCode(client)}-${boxNumber}`;
        }

        // ============================================
        // SHIFT MANAGEMENT FUNCTIONS
        // ============================================
        
        function formatDateTime(date) {
            return new Date(date).toLocaleString('en-AU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }
        
        function formatDateTimeLocal(date) {
            const d = new Date(date);
            const offset = d.getTimezoneOffset();
            const localDate = new Date(d.getTime() - offset * 60 * 1000);
            return localDate.toISOString().slice(0, 16);
        }
        
        function getTodayMidnight() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today;
        }
        
        async function checkShiftStatus() {
            if (!shiftsEnabled) {
                document.getElementById('shiftStatusText').textContent = 'Stock Entry System';
                document.getElementById('shiftHeaderBtn').style.display = 'none';
                return;
            }
            
            try {
                // Check for active shift
                const { data: shifts, error } = await db
                    .from('shifts')
                    .select('*')
                    .eq('user_id', currentUserId)
                    .eq('status', 'active')
                    .order('start_time', { ascending: false })
                    .limit(1);
                
                if (error) throw error;
                
                if (shifts && shifts.length > 0) {
                    const shift = shifts[0];
                    const shiftStart = new Date(shift.start_time);
                    const todayMidnight = getTodayMidnight();
                    
                    // Check if shift is stale (started before today's midnight)
                    if (shiftStart < todayMidnight) {
                        staleShift = shift;
                        activeShift = null;
                        showStaleShiftModal();
                    } else {
                        activeShift = shift;
                        staleShift = null;
                        updateShiftDisplay();
                    }
                } else {
                    activeShift = null;
                    staleShift = null;
                    updateShiftDisplay();
                }
            } catch (error) {
                console.error('Error checking shift status:', error);
                document.getElementById('shiftStatusText').textContent = 'Error loading shift';
            }
        }
        
        function updateShiftDisplay() {
            const statusText = document.getElementById('shiftStatusText');
            const headerBtn = document.getElementById('shiftHeaderBtn');
            
            if (!shiftsEnabled) {
                statusText.textContent = 'Stock Entry System';
                headerBtn.style.display = 'none';
                return;
            }
            
            if (activeShift) {
                const startTime = new Date(activeShift.start_time);
                const timeStr = startTime.toLocaleTimeString('en-AU', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: true 
                });
                statusText.innerHTML = `<span class="shift-active-indicator"></span> Active Shift ‚Ä¢ Started ${timeStr}`;
                headerBtn.textContent = 'End Shift';
                headerBtn.className = 'btn btn-sm btn-danger shift-header-btn';
                headerBtn.style.display = 'inline-flex';
                headerBtn.onclick = openEndShiftModal;
            } else {
                statusText.textContent = 'No Active Shift';
                headerBtn.textContent = 'Start Shift';
                headerBtn.className = 'btn btn-sm btn-primary shift-header-btn';
                headerBtn.style.display = 'inline-flex';
                headerBtn.onclick = openStartShiftModal;
            }
        }
        
        // Start Shift Modal
        function openStartShiftModal() {
            document.getElementById('startShiftTime').value = formatDateTimeLocal(new Date());
            document.getElementById('startShiftKms').value = '';
            document.getElementById('startShiftAlertContainer').innerHTML = '';
            document.getElementById('startShiftModal').classList.add('active');
        }
        
        function closeStartShiftModal() {
            document.getElementById('startShiftModal').classList.remove('active');
        }
        
        async function handleStartShift(e) {
            e.preventDefault();
            
            const startTime = document.getElementById('startShiftTime').value;
            const startKms = parseInt(document.getElementById('startShiftKms').value);
            
            if (!startTime || isNaN(startKms)) {
                showAlert('Please fill in all required fields', 'error', 'startShiftAlertContainer');
                return;
            }
            
            showLoading(true);
            
            try {
                const { data, error } = await db
                    .from('shifts')
                    .insert([{
                        user_id: currentUserId,
                        agent_id: currentAgent,
                        start_time: new Date(startTime).toISOString(),
                        start_kms: startKms,
                        status: 'active'
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                activeShift = data;
                closeStartShiftModal();
                updateShiftDisplay();
                showAlert('‚úì Shift started successfully', 'success');
                showSyncStatus('‚úì Synced', 'synced');
            } catch (error) {
                console.error('Error starting shift:', error);
                showAlert('Error starting shift: ' + error.message, 'error', 'startShiftAlertContainer');
            } finally {
                showLoading(false);
            }
        }
        
        // End Shift Modal
        function openEndShiftModal() {
            document.getElementById('endShiftTime').value = formatDateTimeLocal(new Date());
            document.getElementById('endShiftKms').value = '';
            document.getElementById('extraJobs').value = '0';
            document.getElementById('endShiftAlertContainer').innerHTML = '';
            document.getElementById('endShiftModal').classList.add('active');
        }
        
        function closeEndShiftModal() {
            document.getElementById('endShiftModal').classList.remove('active');
        }
        
        async function handleEndShift(e) {
            e.preventDefault();
            
            const endTime = document.getElementById('endShiftTime').value;
            const endKms = parseInt(document.getElementById('endShiftKms').value);
            const extraJobs = parseInt(document.getElementById('extraJobs').value) || 0;
            
            if (!endTime || isNaN(endKms)) {
                showAlert('Please fill in all required fields', 'error', 'endShiftAlertContainer');
                return;
            }
            
            if (endKms < activeShift.start_kms) {
                showAlert('End kilometres cannot be less than start kilometres', 'error', 'endShiftAlertContainer');
                return;
            }
            
            showLoading(true);
            
            try {
                const { data, error } = await db
                    .from('shifts')
                    .update({
                        end_time: new Date(endTime).toISOString(),
                        end_kms: endKms,
                        extra_jobs: extraJobs,
                        status: 'completed'
                    })
                    .eq('id', activeShift.id)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Generate report
                await generateShiftReport(data);
                
                activeShift = null;
                closeEndShiftModal();
                updateShiftDisplay();
                showSyncStatus('‚úì Synced', 'synced');
            } catch (error) {
                console.error('Error ending shift:', error);
                showAlert('Error ending shift: ' + error.message, 'error', 'endShiftAlertContainer');
            } finally {
                showLoading(false);
            }
        }
        
        // Stale Shift Modal
        function showStaleShiftModal() {
            const shift = staleShift;
            const startDate = new Date(shift.start_time);
            
            document.getElementById('staleShiftDate').textContent = startDate.toLocaleDateString('en-AU', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            document.getElementById('staleShiftStartInfo').value = `${formatDateTime(shift.start_time)} ‚Ä¢ ${shift.start_kms.toLocaleString()} km`;
            
            // Default end time to 11:59 PM of the shift start date
            const defaultEndTime = new Date(startDate);
            defaultEndTime.setHours(23, 59, 0, 0);
            document.getElementById('staleShiftEndTime').value = formatDateTimeLocal(defaultEndTime);
            
            document.getElementById('staleShiftEndKms').value = '';
            document.getElementById('staleExtraJobs').value = '0';
            document.getElementById('staleShiftAlertContainer').innerHTML = '';
            document.getElementById('staleShiftModal').classList.add('active');
        }
        
        async function handleStaleShift(e) {
            e.preventDefault();
            
            const endTime = document.getElementById('staleShiftEndTime').value;
            const endKms = parseInt(document.getElementById('staleShiftEndKms').value);
            const extraJobs = parseInt(document.getElementById('staleExtraJobs').value) || 0;
            
            if (!endTime || isNaN(endKms)) {
                showAlert('Please fill in all required fields', 'error', 'staleShiftAlertContainer');
                return;
            }
            
            if (endKms < staleShift.start_kms) {
                showAlert('End kilometres cannot be less than start kilometres', 'error', 'staleShiftAlertContainer');
                return;
            }
            
            showLoading(true);
            
            try {
                const { data, error } = await db
                    .from('shifts')
                    .update({
                        end_time: new Date(endTime).toISOString(),
                        end_kms: endKms,
                        extra_jobs: extraJobs,
                        status: 'completed'
                    })
                    .eq('id', staleShift.id)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Generate report for the stale shift
                await generateShiftReport(data);
                
                staleShift = null;
                document.getElementById('staleShiftModal').classList.remove('active');
                
                // Re-check shift status (now should show no active shift)
                await checkShiftStatus();
                showSyncStatus('‚úì Synced', 'synced');
            } catch (error) {
                console.error('Error closing stale shift:', error);
                showAlert('Error closing shift: ' + error.message, 'error', 'staleShiftAlertContainer');
            } finally {
                showLoading(false);
            }
        }
        
        // Shift Report
        async function generateShiftReport(shift) {
            const startTime = new Date(shift.start_time);
            const endTime = new Date(shift.end_time);
            
            // Calculate hours
            const hoursWorked = (endTime - startTime) / (1000 * 60 * 60);
            const hours = Math.floor(hoursWorked);
            const minutes = Math.round((hoursWorked - hours) * 60);
            
            // Calculate kilometres
            const kmsTravelled = shift.end_kms - shift.start_kms;
            
            // Count jobs from database during shift timeframe
            let systemJobs = 0;
            try {
                const { count, error } = await db
                    .from('jobs')
                    .select('*', { count: 'exact', head: true })
                    .eq('box_id', db.raw(`(SELECT id FROM boxes WHERE agent = '${currentAgent}')`));
                
                // Actually need to join - let's do a different approach
                const { data: boxes } = await db
                    .from('boxes')
                    .select('id')
                    .eq('agent', currentAgent);
                
                if (boxes && boxes.length > 0) {
                    const boxIds = boxes.map(b => b.id);
                    const { count: jobCount } = await db
                        .from('jobs')
                        .select('*', { count: 'exact', head: true })
                        .in('box_id', boxIds)
                        .gte('created_at', shift.start_time)
                        .lte('created_at', shift.end_time);
                    
                    systemJobs = jobCount || 0;
                }
            } catch (error) {
                console.error('Error counting jobs:', error);
            }
            
            const totalJobs = systemJobs + (shift.extra_jobs || 0);
            
            lastShiftReport = {
                date: startTime.toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }),
                startTime: formatDateTime(shift.start_time),
                endTime: formatDateTime(shift.end_time),
                hoursWorked: `${hours}h ${minutes}m`,
                hoursDecimal: hoursWorked.toFixed(2),
                startKms: shift.start_kms,
                endKms: shift.end_kms,
                kmsTravelled: kmsTravelled,
                systemJobs: systemJobs,
                extraJobs: shift.extra_jobs || 0,
                totalJobs: totalJobs,
                agentId: currentAgent
            };
            
            showShiftReportModal();
        }
        
        function showShiftReportModal() {
            const report = lastShiftReport;
            
            const html = `
                <div class="shift-report-card">
                    <div class="shift-report-header">
                        <div class="shift-report-date">${report.date}</div>
                        <div class="shift-report-agent">Agent ${report.agentId}</div>
                    </div>
                    
                    <div class="shift-report-grid">
                        <div class="shift-report-stat">
                            <div class="shift-report-stat-value">${report.hoursWorked}</div>
                            <div class="shift-report-stat-label">Hours Worked</div>
                            <div class="shift-report-stat-detail">${report.startTime} ‚Üí ${report.endTime}</div>
                        </div>
                        
                        <div class="shift-report-stat">
                            <div class="shift-report-stat-value">${report.kmsTravelled.toLocaleString()} km</div>
                            <div class="shift-report-stat-label">Distance Travelled</div>
                            <div class="shift-report-stat-detail">${report.startKms.toLocaleString()} ‚Üí ${report.endKms.toLocaleString()} km</div>
                        </div>
                        
                        <div class="shift-report-stat">
                            <div class="shift-report-stat-value">${report.totalJobs}</div>
                            <div class="shift-report-stat-label">Total Jobs</div>
                            <div class="shift-report-stat-detail">${report.systemJobs} logged + ${report.extraJobs} extra</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('shiftReportContent').innerHTML = html;
            document.getElementById('shiftReportModal').classList.add('active');
        }
        
        function closeShiftReportModal() {
            document.getElementById('shiftReportModal').classList.remove('active');
        }
        
        function copyShiftReport() {
            const report = lastShiftReport;
            
            const text = `SHIFT REPORT - ${report.date}
Agent: ${report.agentId}

TIME
Start: ${report.startTime}
End: ${report.endTime}
Duration: ${report.hoursWorked} (${report.hoursDecimal} hours)

KILOMETRES
Start: ${report.startKms.toLocaleString()} km
End: ${report.endKms.toLocaleString()} km
Travelled: ${report.kmsTravelled.toLocaleString()} km

JOBS
System Logged: ${report.systemJobs}
Extra Jobs: ${report.extraJobs}
Total: ${report.totalJobs}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showAlert('‚úì Report copied to clipboard', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showAlert('Failed to copy report', 'error');
            });
        }
        
        function downloadShiftReportCSV() {
            const report = lastShiftReport;
            
            const csvContent = `Date,Agent,Start Time,End Time,Hours (Decimal),Start KM,End KM,KM Travelled,System Jobs,Extra Jobs,Total Jobs
"${report.date}","${report.agentId}","${report.startTime}","${report.endTime}",${report.hoursDecimal},${report.startKms},${report.endKms},${report.kmsTravelled},${report.systemJobs},${report.extraJobs},${report.totalJobs}`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const filename = `shift-report-${report.date.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('‚úì CSV downloaded', 'success');
        }

        // ============================================
        // ORIGINAL DASHBOARD FUNCTIONS
        // ============================================

        async function loadAgents() {
            try {
                const { data, error } = await db
                    .from('agents')
                    .select('agent_id')
                    .order('agent_id', { ascending: true });
                
                if (error) throw new Error(error.message);
                if (!data || data.length === 0) return;
                
                const filterAgent = document.getElementById('filterAgent');
                if (filterAgent) {
                    filterAgent.innerHTML = '<option value="">Select an agent...</option>';
                    data.forEach(agent => {
                        const option = document.createElement('option');
                        option.value = agent.agent_id;
                        option.textContent = `Agent ${agent.agent_id}`;
                        filterAgent.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading agents:', error);
                showAlert('Error loading agents: ' + error.message, 'error');
            }
        }

        async function loadClients() {
            try {
                const { data, error } = await db
                    .from('clients')
                    .select('client_id')
                    .order('client_id', { ascending: true });
                
                if (error) throw new Error(error.message);
                if (!data || data.length === 0) return;
                
                const clientSelect = document.getElementById('clientSelect');
                if (clientSelect) {
                    clientSelect.innerHTML = '<option value="">Select a client...</option>';
                    data.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.client_id;
                        option.textContent = client.client_id;
                        clientSelect.appendChild(option);
                    });
                }
                
                const filterClient = document.getElementById('filterExportClient');
                if (filterClient) {
                    filterClient.innerHTML = '<option value="">Select a client...</option>';
                    data.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.client_id;
                        option.textContent = client.client_id;
                        filterClient.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                showAlert('Error loading clients: ' + error.message, 'error');
            }
        }

        async function updateVendorsByClient(clientId) {
            const vendorSelect = document.getElementById('vendorSelect');
            if (!vendorSelect) return;

            if (!clientId) {
                vendorSelect.innerHTML = '<option value="">Select a client first...</option>';
                return;
            }

            try {
                const { data, error } = await db
                    .from('clients_vendors')
                    .select('vendor_id')
                    .eq('client_id', clientId);
                
                if (error) throw new Error(error.message);
                
                vendorSelect.innerHTML = '<option value="">Select a vendor...</option>';
                
                if (data && data.length > 0) {
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.vendor_id;
                        option.textContent = item.vendor_id;
                        vendorSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.textContent = "No vendors linked to this client";
                    option.disabled = true;
                    vendorSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error loading filtered vendors:', error);
                showAlert('Error loading vendors: ' + error.message, 'error');
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const user = await initAuth(['manager', 'technician']);
            if (!user) return;
            
            currentAgent = user.agent_id;
            currentUserRole = user.role;
            currentUserId = user.id;
            
            // Check if shifts are enabled for this user
            try {
                const { data: userData, error } = await db
                    .from('user_roles')
                    .select('shifts_enabled')
                    .eq('user_id', currentUserId)
                    .single();
                
                if (!error && userData) {
                    shiftsEnabled = userData.shifts_enabled || false;
                }
            } catch (error) {
                console.error('Error checking shift settings:', error);
            }
            
            document.getElementById("hamburgerBtn").classList.add("visible");
            document.getElementById("mainForm").classList.add("active");
            
            await Promise.all([
                loadAgents(),
                loadClients(),
                loadBoxesForAgent(),
                checkShiftStatus()
            ]);

            // Event Listeners
            document.getElementById("hamburgerBtn").addEventListener("click", toggleSidebar);
            document.getElementById("sidebarOverlay").addEventListener("click", closeSidebar);
            document.getElementById("sidebarClose").addEventListener("click", closeSidebar);
            document.getElementById("menuMain").addEventListener("click", () => switchPage("main"));
            document.getElementById("menuExport").addEventListener("click", () => switchPage("export"));

            document.getElementById("clientSelect").addEventListener("change", handleClientChange);
            document.getElementById("bulkToggle").addEventListener("change", handleBulkToggle);
            document.getElementById("bulkToggle2").addEventListener("change", handleBulkToggle2);
            document.getElementById("addSerialBtn").addEventListener("click", addSerialRow);
            document.getElementById("addJobBtn").addEventListener("click", handleAddJob);
            document.getElementById("newBoxBtn").addEventListener("click", handleNewBox);

            document.getElementById("loadBoxesBtn").addEventListener("click", loadBoxes);
            document.getElementById("clearExportFiltersBtn").addEventListener("click", clearExportPage);
            
            document.getElementById("filterAgent").addEventListener("change", resetExportResults);
            document.getElementById("filterExportClient").addEventListener("change", resetExportResults);
            
            // Shift form listeners
            document.getElementById("startShiftForm").addEventListener("submit", handleStartShift);
            document.getElementById("endShiftForm").addEventListener("submit", handleEndShift);
            document.getElementById("staleShiftForm").addEventListener("submit", handleStaleShift);
        });

        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("active");
            document.getElementById("sidebarOverlay").classList.toggle("active");
            document.getElementById("hamburgerBtn").classList.toggle("active");
        }

        function closeSidebar() {
            document.getElementById("sidebar").classList.remove("active");
            document.getElementById("sidebarOverlay").classList.remove("active");
            document.getElementById("hamburgerBtn").classList.remove("active");
        }

        function switchPage(page) {
            document.querySelectorAll(".page-content").forEach(p => p.classList.remove("active"));
            document.querySelectorAll(".sidebar-menu-item[data-page]").forEach(m => m.classList.remove("active"));
            
            document.getElementById(page === "main" ? "mainPage" : "exportPage").classList.add("active");
            document.getElementById(page === "main" ? "menuMain" : "menuExport").classList.add("active");
            
            closeSidebar();
        }

        function handleBulkToggle() {
            const isBulk = document.getElementById("bulkToggle").checked;
            document.getElementById("individualEntry").classList.toggle("hidden", isBulk);
            document.getElementById("bulkEntry").classList.toggle("active", isBulk);
            document.getElementById("bulkToggle2").checked = isBulk;
        }

        function handleBulkToggle2() {
            const isBulk = document.getElementById("bulkToggle2").checked;
            document.getElementById("individualEntry").classList.toggle("hidden", isBulk);
            document.getElementById("bulkEntry").classList.toggle("active", isBulk);
            document.getElementById("bulkToggle").checked = isBulk;
        }

        function addSerialRow() {
            const row = document.createElement("div");
            row.className = "serial-input-row";
            row.innerHTML = `
                <input type="text" class="form-input serial-input" placeholder="Enter serial number">
                <button type="button" class="btn btn-danger btn-icon btn-remove" onclick="this.parentElement.remove()">√ó</button>
            `;
            document.getElementById("serialInputs").appendChild(row);
        }

        async function handleClientChange() {
            const client = document.getElementById("clientSelect").value;
            
            await updateVendorsByClient(client);

            if (!client) {
                currentBox = null;
                updateCurrentBoxDisplay();
                return;
            }
            
            showLoading(true);
            
            try {
                const { data, error } = await db
                    .from("boxes")
                    .select("*")
                    .eq("agent", currentAgent)
                    .eq("client", client)
                    .eq("status", "open")
                    .order("created_at", { ascending: false })
                    .limit(1);
                    
                if (error) throw error;
                
                if (data && data.length > 0) {
                    currentBox = data[0];
                    await loadJobsForBox(currentBox.id);
                } else {
                    const boxNumber = await getNextBoxNumber(client);
                    const boxId = formatBoxId(currentAgent, client, boxNumber);
                    
                    const { data: newBox, error: insertError } = await db
                        .from("boxes")
                        .insert([{
                            box_id: boxId,
                            agent: currentAgent,
                            client: client,
                            box_number: boxNumber,
                            status: "open",
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();
                        
                    if (insertError) throw insertError;
                    
                    currentBox = newBox;
                    currentBox.jobs = [];
                }
                
                updateCurrentBoxDisplay();
                await loadBoxesForAgent();
                showSyncStatus("‚úì Synced", "synced");
            } catch (error) {
                showAlert("Error loading box: " + error.message, "error");
                showSyncStatus("‚úï Sync failed", "error");
            } finally {
                showLoading(false);
            }
        }

        async function handleAddJob() {
            if (!currentBox) {
                showAlert("Please select a client first", "error");
                return;
            }
            
            const vendor = document.getElementById("vendorSelect").value;
            const jobNumber = document.getElementById("jobNumber").value.trim();
            const isBulk = document.getElementById("bulkToggle").checked;
            
            if (!vendor || !jobNumber) {
                showAlert("Please fill in all required fields", "error");
                return;
            }
            
            let serials = [];
            
            if (isBulk) {
                const bulkText = document.getElementById("bulkSerials").value.trim();
                if (!bulkText) {
                    showAlert("Please enter at least one serial", "error");
                    return;
                }
                serials = bulkText.split("\n").map(s => s.trim()).filter(s => s.length > 0);
            } else {
                document.querySelectorAll(".serial-input").forEach(input => {
                    const value = input.value.trim();
                    if (value) serials.push(value);
                });
            }
            
            if (serials.length === 0) {
                showAlert("Please enter at least one serial", "error");
                return;
            }
            
            const duplicates = await checkDuplicates(serials);
            if (duplicates.length > 0) {
                showAlert(`Duplicate serials found: ${duplicates.join(", ")}`, "warning");
                return;
            }
            
            showLoading(true);
            showSyncStatus("Syncing...", "syncing");
            
            try {
                const { data: job, error: jobError } = await db
                    .from("jobs")
                    .insert([{
                        box_id: currentBox.id,
                        job_number: jobNumber,
                        vendor: vendor,
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                    
                if (jobError) throw jobError;
                
                const serialRecords = serials.map(serial => ({
                    job_id: job.id,
                    box_id: currentBox.id,
                    serial_number: serial,
                    created_at: new Date().toISOString()
                }));
                
                const { error: serialError } = await db.from("serials").insert(serialRecords);
                if (serialError) throw serialError;
                
                showAlert(`‚úì Job ${jobNumber} added with ${serials.length} serial(s)`, "success");
                showSyncStatus("‚úì Synced", "synced");
                clearJobForm();
                await document.getElementById("clientSelect").dispatchEvent(new Event("change"));
            } catch (error) {
                showAlert("Error saving job: " + error.message, "error");
                showSyncStatus("‚úï Sync failed", "error");
            } finally {
                showLoading(false);
            }
        }

        async function handleNewBox() {
            if (!currentBox || !currentBox.jobs || currentBox.jobs.length === 0) {
                showAlert("Cannot start new box without adding jobs to current one", "warning");
                return;
            }
            
            if (!confirm(`Close current box and start new box for ${currentBox.client}?`)) return;
            
            showLoading(true);
            
            try {
                const client = currentBox.client;
                
                await db
                    .from("boxes")
                    .update({ status: "closed", closed_at: new Date().toISOString() })
                    .eq("id", currentBox.id);
                    
                const boxNumber = await getNextBoxNumber(client);
                const boxId = formatBoxId(currentAgent, client, boxNumber);
                
                const { data: newBox, error } = await db
                    .from("boxes")
                    .insert([{
                        box_id: boxId,
                        agent: currentAgent,
                        client: client,
                        box_number: boxNumber,
                        status: "open",
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                    
                if (error) throw error;
                
                currentBox = newBox;
                currentBox.jobs = [];
                updateCurrentBoxDisplay();
                await loadBoxesForAgent();
                showAlert(`‚úì New box started: ${currentBox.box_id}`, "success");
                showSyncStatus("‚úì Synced", "synced");
            } catch (error) {
                showAlert("Error starting new box: " + error.message, "error");
                showSyncStatus("‚úï Sync failed", "error");
            } finally {
                showLoading(false);
            }
        }

        async function loadJobsForBox(boxId) {
            try {
                const { data: jobs, error } = await db
                    .from("jobs")
                    .select("*")
                    .eq("box_id", boxId)
                    .order("created_at", { ascending: true });
                    
                if (error) throw error;
                
                for (let job of jobs) {
                    const { data: serials } = await db
                        .from("serials")
                        .select("serial_number")
                        .eq("job_id", job.id);
                        
                    job.serials = serials ? serials.map(s => s.serial_number) : [];
                }
                
                currentBox.jobs = jobs;
            } catch (error) {
                currentBox.jobs = [];
            }
        }

        async function getNextBoxNumber(client) {
            try {
                const { data } = await db
                    .from("boxes")
                    .select("box_number")
                    .eq("agent", currentAgent)
                    .eq("client", client)
                    .order("box_number", { ascending: false })
                    .limit(1);
                    
                if (data && data.length > 0) {
                    return String(parseInt(data[0].box_number) + 1).padStart(3, "0");
                }
                return "001";
            } catch (error) {
                return "001";
            }
        }

        function updateCurrentBoxDisplay() {
            const boxIdEl = document.getElementById("currentBoxId");
            const boxClientEl = document.getElementById("currentBoxClient");
            const jobsSummaryEl = document.getElementById("jobsSummary");
            const newBoxBtn = document.getElementById("newBoxBtn");
            
            if (currentBox) {
                boxIdEl.textContent = currentBox.box_id;
                boxClientEl.textContent = `${currentBox.client} ‚Ä¢ Agent ${currentBox.agent}`;
                
                const jobs = currentBox.jobs || [];
                const jobCount = jobs.length;
                const serialCount = jobs.reduce((sum, job) => sum + (job.serials ? job.serials.length : 0), 0);
                
                jobsSummaryEl.textContent = `${jobCount} job(s) ‚Ä¢ ${serialCount} serial(s)`;
                newBoxBtn.disabled = false;
            } else {
                boxIdEl.textContent = "No Active Box";
                boxClientEl.textContent = "Select a client to begin";
                jobsSummaryEl.textContent = "";
                newBoxBtn.disabled = true;
            }
        }

        async function checkDuplicates(serials) {
            try {
                const { data } = await db
                    .from("serials")
                    .select("serial_number")
                    .in("serial_number", serials);
                    
                return data ? data.map(s => s.serial_number) : [];
            } catch (error) {
                return [];
            }
        }

        async function loadBoxesForAgent() {
            try {
                const { data } = await db
                    .from("boxes")
                    .select("*")
                    .eq("agent", currentAgent)
                    .order("created_at", { ascending: false });
                    
                boxes = data || [];
            } catch (error) {
                boxes = [];
            }
        }

        function clearJobForm() {
            document.getElementById("vendorSelect").value = "";
            document.getElementById("jobNumber").value = "";
            document.getElementById("bulkSerials").value = "";
            document.getElementById("bulkToggle").checked = false;
            document.getElementById("bulkToggle2").checked = false;
            document.getElementById("serialInputs").innerHTML = `
                <div class="serial-input-row">
                    <input type="text" class="form-input serial-input" placeholder="Enter serial number">
                </div>
            `;
            handleBulkToggle();
        }

        function showAlert(message, type, containerId = "alertContainer") {
            const container = document.getElementById(containerId);
            const alert = document.createElement("div");
            alert.className = `alert alert-${type}`;
            
            const icons = { success: "‚úì", error: "‚úï", warning: "‚ö†", info: "‚Ñπ" };
            alert.innerHTML = `<span class="alert-icon">${icons[type] || "‚Ñπ"}</span><span>${message}</span>`;
            
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function showLoading(show) {
            document.getElementById("loading").classList.toggle("active", show);
        }

        function showSyncStatus(message, type) {
            const status = document.getElementById("syncStatus");
            status.textContent = message;
            status.className = `sync-status active ${type}`;
            setTimeout(() => status.classList.remove("active"), 3000);
        }

        // Export Page Functions
        let selectedExportBox = null;

        function resetExportResults() {
            clearExportPreview();
            document.getElementById("exportResults").innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <p>Select an agent and client, then click "Load Boxes"</p>
                </div>
            `;
        }

        async function loadBoxes() {
            const agent = document.getElementById("filterAgent").value;
            const client = document.getElementById("filterExportClient").value;
            
            if (!agent || !client) {
                showAlert("Please select both agent and client", "error");
                return;
            }
            
            showLoading(true);
            
            try {
                const { data: boxesData, error } = await db
                    .from("boxes")
                    .select("*")
                    .eq("agent", agent)
                    .eq("client", client)
                    .order("created_at", { ascending: false });
                    
                if (error) throw error;
                
                if (!boxesData || boxesData.length === 0) {
                    document.getElementById("exportResults").innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No boxes found for selected filters</p>
                        </div>
                    `;
                    return;
                }
                
                for (let box of boxesData) {
                    const { count: jobCount } = await db
                        .from("jobs")
                        .select("*", { count: "exact", head: true })
                        .eq("box_id", box.id);
                        
                    const { count: serialCount } = await db
                        .from("serials")
                        .select("*", { count: "exact", head: true })
                        .eq("box_id", box.id);
                        
                    box.jobCount = jobCount || 0;
                    box.serialCount = serialCount || 0;
                }
                
                renderBoxesList(boxesData);
            } catch (error) {
                showAlert("Error loading boxes: " + error.message, "error");
            } finally {
                showLoading(false);
            }
        }

        function renderBoxesList(boxesData) {
            const container = document.getElementById("exportResults");
            
            let html = `<div class="card"><h3 style="margin-bottom: 16px; color: var(--text-primary);">Select a Box</h3><div class="box-list">`;
            
            boxesData.forEach(box => {
                const closedDate = box.status === 'closed' && box.closed_at 
                    ? ` ‚Ä¢ Closed: ${new Date(box.closed_at).toLocaleDateString()}` 
                    : '';
                    
                html += `
                    <div class="box-item" onclick="selectBoxForExport(${box.id}); generateExportPreview();">
                        <div class="box-info">
                            <div class="box-id">${box.box_id}</div>
                            <div class="box-meta">${box.jobCount} jobs ‚Ä¢ ${box.serialCount} serials${closedDate}</div>
                        </div>
                        <span class="badge badge-${box.status}">${box.status}</span>
                    </div>
                `;
            });
            
            html += `</div></div>`;
            container.innerHTML = html;
        }

        async function selectBoxForExport(boxId) {
            document.querySelectorAll(".box-item").forEach(el => el.classList.remove("selected"));
            event.currentTarget.classList.add("selected");
            selectedExportBox = boxId;
        }

        async function generateExportPreview() {
            if (!selectedExportBox) return;
            
            showLoading(true);
            
            try {
                const { data: box } = await db
                    .from("boxes")
                    .select("*")
                    .eq("id", selectedExportBox)
                    .single();
                    
                const { data: jobs } = await db
                    .from("jobs")
                    .select("*")
                    .eq("box_id", selectedExportBox)
                    .order("created_at", { ascending: false });
                    
                let html = `
                    <div class="export-box-item">
                        <div class="export-box-header">
                            <div class="export-box-title">${box.box_id}</div>
                            <div class="export-box-subtitle">
                                Agent: ${box.agent} ‚Ä¢ Client: ${box.client}
                                ${box.status === 'closed' && box.closed_at ? ` ‚Ä¢ Closed: ${new Date(box.closed_at).toLocaleDateString()}` : ''}
                            </div>
                        </div>
                `;
                
                for (let job of jobs) {
                    const { data: serials } = await db
                        .from("serials")
                        .select("serial_number")
                        .eq("job_id", job.id)
                        .order("created_at", { ascending: true });
                        
                    html += `
                        <div class="job-section" onclick="toggleJobExpand(this)">
                            <div class="job-date">Created: ${new Date(job.created_at).toLocaleString()}</div>
                            <div class="job-header">
                                <span>Job: ${job.job_number} ‚Ä¢ Vendor: ${job.vendor} ‚Ä¢ ${serials.length} serials</span>
                                <span class="job-expand-icon">‚ñº</span>
                            </div>
                            <div class="serial-grid">
                    `;
                    
                    serials.forEach((serial, index) => {
                        const barcodeId = `barcode-${selectedExportBox}-${Date.now()}-${index}`;
                        html += `
                            <div class="serial-item">
                                <div class="serial-number">${serial.serial_number}</div>
                                <div class="barcode-container">
                                    <svg class="barcode-svg" data-serial="${serial.serial_number}" data-id="${barcodeId}"></svg>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                            <div class="job-edit-actions">
                                ${canEditJob(box.agent) ? `<button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); openEditJobModal(${job.id}, '${box.client}', '${box.agent}')">
                                    ‚úèÔ∏è Edit Job
                                </button>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    </div>
                    <div style="text-align: center; margin-top: 24px;">
                        <button class="btn btn-primary" onclick="window.print()">üìÑ Generate PDF</button>
                        <button class="btn btn-ghost" onclick="clearExportPreview()" style="margin-left: 12px;">Close</button>
                    </div>
                `;
                
                const preview = document.getElementById("exportPreview");
                preview.innerHTML = html;
                preview.classList.remove("hidden");
                
                setTimeout(() => {
                    document.querySelectorAll(".barcode-svg").forEach(svg => {
                        const serial = svg.getAttribute("data-serial");
                        const id = svg.getAttribute("data-id");
                        
                        try {
                            svg.setAttribute("id", id);
                            JsBarcode(`#${id}`, serial, {
                                format: "CODE128",
                                width: 2,
                                height: 50,
                                displayValue: false,
                                margin: 5
                            });
                        } catch (e) {
                            console.error("Barcode error:", e);
                        }
                    });
                }, 100);
                
                showAlert("‚úì Export preview generated", "success");
            } catch (error) {
                showAlert("Error generating export: " + error.message, "error");
            } finally {
                showLoading(false);
            }
        }

        function toggleJobExpand(element) {
            element.classList.toggle('expanded');
        }

        function clearExportPreview() {
            document.getElementById("exportPreview").innerHTML = "";
            document.getElementById("exportPreview").classList.add("hidden");
            document.getElementById("exportBoxSelection").classList.add("hidden");
            selectedExportBox = null;
            document.querySelectorAll(".box-item").forEach(el => el.classList.remove("selected"));
        }

        function clearExportPage() {
            document.getElementById("filterAgent").value = "";
            document.getElementById("filterExportClient").value = "";
            resetExportResults();
            clearExportPreview();
        }

        // Edit Job Functions
        function canEditJob(boxAgent) {
            if (currentUserRole === 'manager') {
                return true;
            }
            if (currentUserRole === 'technician') {
                return boxAgent === currentAgent;
            }
            return false;
        }
        
        async function openEditJobModal(jobId, clientId, boxAgent) {
            if (!canEditJob(boxAgent)) {
                showAlert("You don't have permission to edit this job", "error");
                return;
            }
            
            try {
                const { data: job, error: jobError } = await db
                    .from("jobs")
                    .select("*")
                    .eq("id", jobId)
                    .single();
                
                if (jobError) throw jobError;
                
                const { data: serials, error: serialsError } = await db
                    .from("serials")
                    .select("serial_number")
                    .eq("job_id", jobId)
                    .order("created_at", { ascending: true });
                
                if (serialsError) throw serialsError;
                
                const { data: vendors, error: vendorsError } = await db
                    .from('clients_vendors')
                    .select('vendor_id')
                    .eq('client_id', clientId);
                
                if (vendorsError) throw vendorsError;
                
                document.getElementById("editJobNumber").value = job.job_number;
                
                const vendorSelect = document.getElementById("editVendorSelect");
                vendorSelect.innerHTML = '<option value="">Select a vendor...</option>';
                vendors.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.vendor_id;
                    option.textContent = item.vendor_id;
                    if (item.vendor_id === job.vendor) {
                        option.selected = true;
                    }
                    vendorSelect.appendChild(option);
                });
                
                document.getElementById("editSerials").value = serials.map(s => s.serial_number).join("\n");
                
                editingJob = {
                    id: jobId,
                    boxId: job.box_id,
                    originalSerials: serials.map(s => s.serial_number)
                };
                
                document.getElementById("editJobAlertContainer").innerHTML = "";
                document.getElementById("editJobModal").classList.add("active");
            } catch (error) {
                showAlert("Error loading job data: " + error.message, "error");
            }
        }

        function closeEditJobModal() {
            document.getElementById("editJobModal").classList.remove("active");
            editingJob = null;
        }

        async function saveJobEdit() {
            if (!editingJob) return;
            
            const { data: job } = await db
                .from("jobs")
                .select("box_id")
                .eq("id", editingJob.id)
                .single();
            
            if (job) {
                const { data: box } = await db
                    .from("boxes")
                    .select("agent")
                    .eq("id", job.box_id)
                    .single();
                
                if (box && !canEditJob(box.agent)) {
                    showAlert("You don't have permission to edit this job", "error", "editJobAlertContainer");
                    return;
                }
            }
            
            const jobNumber = document.getElementById("editJobNumber").value.trim();
            const vendor = document.getElementById("editVendorSelect").value;
            const serialsText = document.getElementById("editSerials").value.trim();
            
            if (!jobNumber || !vendor || !serialsText) {
                showAlert("Please fill in all required fields", "error", "editJobAlertContainer");
                return;
            }
            
            const newSerials = serialsText.split("\n").map(s => s.trim()).filter(s => s.length > 0);
            
            if (newSerials.length === 0) {
                showAlert("Please enter at least one serial", "error", "editJobAlertContainer");
                return;
            }
            
            const serialsToCheck = newSerials.filter(s => !editingJob.originalSerials.includes(s));
            if (serialsToCheck.length > 0) {
                const duplicates = await checkDuplicates(serialsToCheck);
                if (duplicates.length > 0) {
                    showAlert(`Duplicate serials found: ${duplicates.join(", ")}`, "warning", "editJobAlertContainer");
                    return;
                }
            }
            
            showLoading(true);
            
            try {
                const { error: jobError } = await db
                    .from("jobs")
                    .update({
                        job_number: jobNumber,
                        vendor: vendor
                    })
                    .eq("id", editingJob.id);
                
                if (jobError) throw jobError;
                
                const { error: deleteError } = await db
                    .from("serials")
                    .delete()
                    .eq("job_id", editingJob.id);
                
                if (deleteError) throw deleteError;
                
                const serialRecords = newSerials.map(serial => ({
                    job_id: editingJob.id,
                    box_id: editingJob.boxId,
                    serial_number: serial,
                    created_at: new Date().toISOString()
                }));
                
                const { error: serialError } = await db
                    .from("serials")
                    .insert(serialRecords);
                
                if (serialError) throw serialError;
                
                showAlert("‚úì Job updated successfully", "success");
                closeEditJobModal();
                
                await generateExportPreview();
            } catch (error) {
                showAlert("Error updating job: " + error.message, "error", "editJobAlertContainer");
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>