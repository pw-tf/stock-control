<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Stock Submission</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="auth.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- Sync Status -->
    <div class="sync-status" id="syncStatus"></div>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Hamburger Button -->
    <button class="hamburger-btn" id="hamburgerBtn">
        <span></span>
        <span></span>
        <span></span>
    </button>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Navigation</h2>
            <button class="sidebar-close" id="sidebarClose">√ó</button>
        </div>
        <div class="sidebar-menu">
            <div class="sidebar-menu-item active" data-page="main" id="menuMain">
                <span>üìã</span>
                <span>Stock Entry</span>
            </div>
            <div class="sidebar-menu-item" data-page="export" id="menuExport">
                <span>üìä</span>
                <span>View Boxes</span>
            </div>
            <div class="sidebar-menu-item" data-role="manager" onclick="window.location.href='admin.html'">
                <span>‚öôÔ∏è</span>
                <span>Admin Panel</span>
            </div>
            <div class="sidebar-menu-item" onclick="logout()">
                <span>üö™</span>
                <span>Sign Out</span>
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="app-wrapper">
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <div class="header-icon">üì¶</div>
                    <div>
                        <h1>Stock Submission</h1>
                        <div class="header-subtitle">Inventory Management System</div>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <!-- Main Page: Stock Entry -->
                <div class="page-content active" id="mainPage">
                    <div class="main-form" id="mainForm">
                        <div id="alertContainer"></div>
                        
                        <!-- Current Box Status Card -->
                        <div class="status-card">
                            <div class="status-card-content">
                                <h3 id="currentBoxId">No Active Box</h3>
                                <p id="currentBoxClient">Select a client to begin</p>
                                <div class="status-card-meta" id="jobsSummary"></div>
                            </div>
                            <button class="btn btn-danger" id="newBoxBtn" disabled>
                                Start New Box
                            </button>
                        </div>
                        
                        <!-- Form Fields -->
                        <div class="card">
                            <div class="form-group">
                                <label class="form-label" for="clientSelect">
                                    Client <span class="required">*</span>
                                </label>
                                <select id="clientSelect" class="form-select">
                                    <option value="">Select a client...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="vendorSelect">
                                    Vendor <span class="required">*</span>
                                </label>
                                <select id="vendorSelect" class="form-select">
                                    <option value="">Select a vendor...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="jobNumber">
                                    Job Number <span class="required">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="jobNumber" 
                                    class="form-input" 
                                    placeholder="Enter job number"
                                >
                            </div>
                            
                            <!-- Individual Serial Entry -->
                            <div class="form-group individual-entry-area" id="individualEntry">
                                <label class="form-label">
                                    Serial Numbers <span class="required">*</span>
                                </label>
                                <div class="serial-inputs" id="serialInputs">
                                    <div class="serial-input-row">
                                        <input type="text" class="form-input serial-input" placeholder="Enter serial number">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 12px;">
                                    <button class="btn btn-primary" id="addSerialBtn">
                                        + Add Another Serial
                                    </button>
                                    <!-- Bulk Entry Toggle -->
                                    <div class="toggle-container" style="margin: 0;">
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="bulkToggle">
                                            <div class="toggle-slider"></div>
                                        </div>
                                        <label class="toggle-label" for="bulkToggle">Bulk Entry Mode</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bulk Serial Entry -->
                            <div class="bulk-entry-area" id="bulkEntry">
                                <div class="form-group">
                                    <label class="form-label" for="bulkSerials">
                                        Serial Numbers <span class="required">*</span>
                                        <span style="font-weight: 400; color: var(--text-muted);">(one per line)</span>
                                    </label>
                                    <textarea 
                                        id="bulkSerials" 
                                        class="form-textarea" 
                                        placeholder="Enter serial numbers, one per line..."
                                    ></textarea>
                                    <div style="margin-top: 12px;">
                                        <!-- Bulk Entry Toggle (for turning off) -->
                                        <div class="toggle-container" style="margin: 0;">
                                            <div class="toggle-switch">
                                                <input type="checkbox" id="bulkToggle2" checked>
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <label class="toggle-label" for="bulkToggle2">Bulk Entry Mode</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="button-group">
                                <button class="btn btn-primary" id="addJobBtn">
                                    Add Job to Box
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Export Page: View Boxes -->
                <div class="page-content" id="exportPage">
                    <div class="export-filters">
                        <h2>View Boxes</h2>
                        <div class="filter-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" for="filterAgent">
                                    Agent <span class="required">*</span>
                                </label>
                                <select id="filterAgent" class="form-select">
                                    <option value="">Select an agent...</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label class="form-label" for="filterExportClient">
                                    Client <span class="required">*</span>
                                </label>
                                <select id="filterExportClient" class="form-select">
                                    <option value="">Select a client...</option>
                                </select>
                            </div>
                        </div>
                        <div class="button-group" style="margin-top: 16px;">
                            <button class="btn btn-primary" id="loadBoxesBtn">Load Boxes</button>
                            <button class="btn btn-ghost" id="clearExportFiltersBtn">Clear Selection</button>
                        </div>
                    </div>
                    
                    <div class="export-results" id="exportResults">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <p>Select an agent and client, then click "Load Boxes"</p>
                        </div>
                    </div>
                    
                    <div class="export-box-selection hidden" id="exportBoxSelection"></div>
                    <div class="export-preview hidden" id="exportPreview"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
let currentAgent, boxes = [], currentBox;

        function getClientCode(client) {
            return client ? client.substring(0, 3).toUpperCase() : "OTH";
        }

        function formatBoxId(agent, client, boxNumber) {
            return `${agent}-${getClientCode(client)}-${boxNumber}`;
        }

        async function loadAgents() {
            try {
                const { data, error } = await db
                    .from('agents')
                    .select('agent_id')
                    .order('agent_id', { ascending: true });
                
                if (error) throw new Error(error.message);
                if (!data || data.length === 0) return;
                
                const filterAgent = document.getElementById('filterAgent');
                if (filterAgent) {
                    filterAgent.innerHTML = '<option value="">Select an agent...</option>';
                    data.forEach(agent => {
                        const option = document.createElement('option');
                        option.value = agent.agent_id;
                        option.textContent = `Agent ${agent.agent_id}`;
                        filterAgent.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading agents:', error);
                showAlert('Error loading agents: ' + error.message, 'error');
            }
        }

        async function loadClients() {
            try {
                const { data, error } = await db
                    .from('clients')
                    .select('client_id')
                    .order('client_id', { ascending: true });
                
                if (error) throw new Error(error.message);
                if (!data || data.length === 0) return;
                
                const clientSelect = document.getElementById('clientSelect');
                if (clientSelect) {
                    clientSelect.innerHTML = '<option value="">Select a client...</option>';
                    data.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.client_id;
                        option.textContent = client.client_id;
                        clientSelect.appendChild(option);
                    });
                }
                
                const filterClient = document.getElementById('filterExportClient');
                if (filterClient) {
                    filterClient.innerHTML = '<option value="">Select a client...</option>';
                    data.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.client_id;
                        option.textContent = client.client_id;
                        filterClient.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                showAlert('Error loading clients: ' + error.message, 'error');
            }
        }

        // Updated function to filter vendors based on the selected client
        async function updateVendorsByClient(clientId) {
            const vendorSelect = document.getElementById('vendorSelect');
            if (!vendorSelect) return;

            if (!clientId) {
                vendorSelect.innerHTML = '<option value="">Select a client first...</option>';
                return;
            }

            try {
                // Fetch vendor IDs from the linking table for the specific client
                const { data, error } = await db
                    .from('clients_vendors')
                    .select('vendor_id')
                    .eq('client_id', clientId);
                
                if (error) throw new Error(error.message);
                
                vendorSelect.innerHTML = '<option value="">Select a vendor...</option>';
                
                if (data && data.length > 0) {
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.vendor_id;
                        option.textContent = item.vendor_id;
                        vendorSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.textContent = "No vendors linked to this client";
                    option.disabled = true;
                    vendorSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error loading filtered vendors:', error);
                showAlert('Error loading vendors: ' + error.message, 'error');
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const user = await initAuth(['manager', 'technician']);
            if (!user) return;
            
            currentAgent = user.agent_id;
            
            document.getElementById("hamburgerBtn").classList.add("visible");
            document.getElementById("mainForm").classList.add("active");
            
            await Promise.all([
                loadAgents(),
                loadClients(),
                loadBoxesForAgent()
            ]);

            // Event Listeners
            document.getElementById("hamburgerBtn").addEventListener("click", toggleSidebar);
            document.getElementById("sidebarOverlay").addEventListener("click", closeSidebar);
            document.getElementById("sidebarClose").addEventListener("click", closeSidebar);
            document.getElementById("menuMain").addEventListener("click", () => switchPage("main"));
            document.getElementById("menuExport").addEventListener("click", () => switchPage("export"));

            document.getElementById("clientSelect").addEventListener("change", handleClientChange);
            document.getElementById("bulkToggle").addEventListener("change", handleBulkToggle);
            document.getElementById("bulkToggle2").addEventListener("change", handleBulkToggle2);
            document.getElementById("addSerialBtn").addEventListener("click", addSerialRow);
            document.getElementById("addJobBtn").addEventListener("click", handleAddJob);
            document.getElementById("newBoxBtn").addEventListener("click", handleNewBox);

            document.getElementById("loadBoxesBtn").addEventListener("click", loadBoxes);
            document.getElementById("clearExportFiltersBtn").addEventListener("click", clearExportPage);
            
            document.getElementById("filterAgent").addEventListener("change", resetExportResults);
            document.getElementById("filterExportClient").addEventListener("change", resetExportResults);
        });

        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("active");
            document.getElementById("sidebarOverlay").classList.toggle("active");
            document.getElementById("hamburgerBtn").classList.toggle("active");
        }

        function closeSidebar() {
            document.getElementById("sidebar").classList.remove("active");
            document.getElementById("sidebarOverlay").classList.remove("active");
            document.getElementById("hamburgerBtn").classList.remove("active");
        }

        function switchPage(page) {
            document.querySelectorAll(".page-content").forEach(p => p.classList.remove("active"));
            document.querySelectorAll(".sidebar-menu-item[data-page]").forEach(m => m.classList.remove("active"));
            
            document.getElementById(page === "main" ? "mainPage" : "exportPage").classList.add("active");
            document.getElementById(page === "main" ? "menuMain" : "menuExport").classList.add("active");
            
            closeSidebar();
        }

        function handleBulkToggle() {
            const isBulk = document.getElementById("bulkToggle").checked;
            document.getElementById("individualEntry").classList.toggle("hidden", isBulk);
            document.getElementById("bulkEntry").classList.toggle("active", isBulk);
            // Sync the second toggle
            document.getElementById("bulkToggle2").checked = isBulk;
        }

        function handleBulkToggle2() {
            const isBulk = document.getElementById("bulkToggle2").checked;
            document.getElementById("individualEntry").classList.toggle("hidden", isBulk);
            document.getElementById("bulkEntry").classList.toggle("active", isBulk);
            // Sync the first toggle
            document.getElementById("bulkToggle").checked = isBulk;
        }

        function addSerialRow() {
            const row = document.createElement("div");
            row.className = "serial-input-row";
            row.innerHTML = `
                <input type="text" class="form-input serial-input" placeholder="Enter serial number">
                <button type="button" class="btn btn-danger btn-icon btn-remove" onclick="this.parentElement.remove()">√ó</button>
            `;
            document.getElementById("serialInputs").appendChild(row);
        }

        async function handleClientChange() {
            const client = document.getElementById("clientSelect").value;
            
            // Trigger the vendor update whenever client changes
            await updateVendorsByClient(client);

            if (!client) {
                currentBox = null;
                updateCurrentBoxDisplay();
                return;
            }
            
            showLoading(true);
            
            try {
                const { data, error } = await db
                    .from("boxes")
                    .select("*")
                    .eq("agent", currentAgent)
                    .eq("client", client)
                    .eq("status", "open")
                    .order("created_at", { ascending: false })
                    .limit(1);
                    
                if (error) throw error;
                
                if (data && data.length > 0) {
                    currentBox = data[0];
                    await loadJobsForBox(currentBox.id);
                } else {
                    const boxNumber = await getNextBoxNumber(client);
                    const boxId = formatBoxId(currentAgent, client, boxNumber);
                    
                    const { data: newBox, error: insertError } = await db
                        .from("boxes")
                        .insert([{
                            box_id: boxId,
                            agent: currentAgent,
                            client: client,
                            box_number: boxNumber,
                            status: "open",
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();
                        
                    if (insertError) throw insertError;
                    
                    currentBox = newBox;
                    currentBox.jobs = [];
                }
                
                updateCurrentBoxDisplay();
                await loadBoxesForAgent();
                showSyncStatus("‚úì Synced", "synced");
            } catch (error) {
                showAlert("Error loading box: " + error.message, "error");
                showSyncStatus("‚úï Sync failed", "error");
            } finally {
                showLoading(false);
            }
        }

        async function handleAddJob() {
            if (!currentBox) {
                showAlert("Please select a client first", "error");
                return;
            }
            
            const vendor = document.getElementById("vendorSelect").value;
            const jobNumber = document.getElementById("jobNumber").value.trim();
            const isBulk = document.getElementById("bulkToggle").checked;
            
            if (!vendor || !jobNumber) {
                showAlert("Please fill in all required fields", "error");
                return;
            }
            
            let serials = [];
            
            if (isBulk) {
                const bulkText = document.getElementById("bulkSerials").value.trim();
                if (!bulkText) {
                    showAlert("Please enter at least one serial", "error");
                    return;
                }
                serials = bulkText.split("\n").map(s => s.trim()).filter(s => s.length > 0);
            } else {
                document.querySelectorAll(".serial-input").forEach(input => {
                    const value = input.value.trim();
                    if (value) serials.push(value);
                });
            }
            
            if (serials.length === 0) {
                showAlert("Please enter at least one serial", "error");
                return;
            }
            
            const duplicates = await checkDuplicates(serials);
            if (duplicates.length > 0) {
                showAlert(`Duplicate serials found: ${duplicates.join(", ")}`, "warning");
                return;
            }
            
            showLoading(true);
            showSyncStatus("Syncing...", "syncing");
            
            try {
                const { data: job, error: jobError } = await db
                    .from("jobs")
                    .insert([{
                        box_id: currentBox.id,
                        job_number: jobNumber,
                        vendor: vendor,
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                    
                if (jobError) throw jobError;
                
                const serialRecords = serials.map(serial => ({
                    job_id: job.id,
                    box_id: currentBox.id,
                    serial_number: serial,
                    created_at: new Date().toISOString()
                }));
                
                const { error: serialError } = await db.from("serials").insert(serialRecords);
                if (serialError) throw serialError;
                
                showAlert(`‚úì Job ${jobNumber} added with ${serials.length} serial(s)`, "success");
                showSyncStatus("‚úì Synced", "synced");
                clearJobForm();
                await document.getElementById("clientSelect").dispatchEvent(new Event("change"));
            } catch (error) {
                showAlert("Error saving job: " + error.message, "error");
                showSyncStatus("‚úï Sync failed", "error");
            } finally {
                showLoading(false);
            }
        }

        async function handleNewBox() {
            if (!currentBox || !currentBox.jobs || currentBox.jobs.length === 0) {
                showAlert("Cannot start new box without adding jobs to current one", "warning");
                return;
            }
            
            if (!confirm(`Close current box and start new box for ${currentBox.client}?`)) return;
            
            showLoading(true);
            
            try {
                const client = currentBox.client;
                
                await db
                    .from("boxes")
                    .update({ status: "closed", closed_at: new Date().toISOString() })
                    .eq("id", currentBox.id);
                    
                const boxNumber = await getNextBoxNumber(client);
                const boxId = formatBoxId(currentAgent, client, boxNumber);
                
                const { data: newBox, error } = await db
                    .from("boxes")
                    .insert([{
                        box_id: boxId,
                        agent: currentAgent,
                        client: client,
                        box_number: boxNumber,
                        status: "open",
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();
                    
                if (error) throw error;
                
                currentBox = newBox;
                currentBox.jobs = [];
                updateCurrentBoxDisplay();
                await loadBoxesForAgent();
                showAlert(`‚úì New box started: ${currentBox.box_id}`, "success");
                showSyncStatus("‚úì Synced", "synced");
            } catch (error) {
                showAlert("Error starting new box: " + error.message, "error");
                showSyncStatus("‚úï Sync failed", "error");
            } finally {
                showLoading(false);
            }
        }

        async function loadJobsForBox(boxId) {
            try {
                const { data: jobs, error } = await db
                    .from("jobs")
                    .select("*")
                    .eq("box_id", boxId)
                    .order("created_at", { ascending: true });
                    
                if (error) throw error;
                
                for (let job of jobs) {
                    const { data: serials } = await db
                        .from("serials")
                        .select("serial_number")
                        .eq("job_id", job.id);
                        
                    job.serials = serials ? serials.map(s => s.serial_number) : [];
                }
                
                currentBox.jobs = jobs;
            } catch (error) {
                currentBox.jobs = [];
            }
        }

        async function getNextBoxNumber(client) {
            try {
                const { data } = await db
                    .from("boxes")
                    .select("box_number")
                    .eq("agent", currentAgent)
                    .eq("client", client)
                    .order("box_number", { ascending: false })
                    .limit(1);
                    
                if (data && data.length > 0) {
                    return String(parseInt(data[0].box_number) + 1).padStart(3, "0");
                }
                return "001";
            } catch (error) {
                return "001";
            }
        }

        function updateCurrentBoxDisplay() {
            const boxIdEl = document.getElementById("currentBoxId");
            const boxClientEl = document.getElementById("currentBoxClient");
            const jobsSummaryEl = document.getElementById("jobsSummary");
            const newBoxBtn = document.getElementById("newBoxBtn");
            
            if (currentBox) {
                boxIdEl.textContent = currentBox.box_id;
                boxClientEl.textContent = `${currentBox.client} ‚Ä¢ Agent ${currentBox.agent}`;
                
                const jobs = currentBox.jobs || [];
                const jobCount = jobs.length;
                const serialCount = jobs.reduce((sum, job) => sum + (job.serials ? job.serials.length : 0), 0);
                
                jobsSummaryEl.textContent = `${jobCount} job(s) ‚Ä¢ ${serialCount} serial(s)`;
                newBoxBtn.disabled = false;
            } else {
                boxIdEl.textContent = "No Active Box";
                boxClientEl.textContent = "Select a client to begin";
                jobsSummaryEl.textContent = "";
                newBoxBtn.disabled = true;
            }
        }

        async function checkDuplicates(serials) {
            try {
                const { data } = await db
                    .from("serials")
                    .select("serial_number")
                    .in("serial_number", serials);
                    
                return data ? data.map(s => s.serial_number) : [];
            } catch (error) {
                return [];
            }
        }

        async function loadBoxesForAgent() {
            try {
                const { data } = await db
                    .from("boxes")
                    .select("*")
                    .eq("agent", currentAgent)
                    .order("created_at", { ascending: false });
                    
                boxes = data || [];
            } catch (error) {
                boxes = [];
            }
        }

        function clearJobForm() {
            document.getElementById("vendorSelect").value = "";
            document.getElementById("jobNumber").value = "";
            document.getElementById("bulkSerials").value = "";
            document.getElementById("bulkToggle").checked = false;
            document.getElementById("bulkToggle2").checked = false;
            document.getElementById("serialInputs").innerHTML = `
                <div class="serial-input-row">
                    <input type="text" class="form-input serial-input" placeholder="Enter serial number">
                </div>
            `;
            handleBulkToggle();
        }

        function showAlert(message, type) {
            const container = document.getElementById("alertContainer");
            const alert = document.createElement("div");
            alert.className = `alert alert-${type}`;
            
            const icons = { success: "‚úì", error: "‚úï", warning: "‚ö†", info: "‚Ñπ" };
            alert.innerHTML = `<span class="alert-icon">${icons[type] || "‚Ñπ"}</span><span>${message}</span>`;
            
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function showLoading(show) {
            document.getElementById("loading").classList.toggle("active", show);
        }

        function showSyncStatus(message, type) {
            const status = document.getElementById("syncStatus");
            status.textContent = message;
            status.className = `sync-status active ${type}`;
            setTimeout(() => status.classList.remove("active"), 3000);
        }

        // Export Page Functions
        let selectedExportBox = null;

        function resetExportResults() {
            clearExportPreview();
            document.getElementById("exportResults").innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üì¶</div>
                    <p>Select an agent and client, then click "Load Boxes"</p>
                </div>
            `;
        }

        async function loadBoxes() {
            const agent = document.getElementById("filterAgent").value;
            const client = document.getElementById("filterExportClient").value;
            
            if (!agent || !client) {
                showAlert("Please select both agent and client", "error");
                return;
            }
            
            showLoading(true);
            
            try {
                const { data: boxesData, error } = await db
                    .from("boxes")
                    .select("*")
                    .eq("agent", agent)
                    .eq("client", client)
                    .order("created_at", { ascending: false });
                    
                if (error) throw error;
                
                if (!boxesData || boxesData.length === 0) {
                    document.getElementById("exportResults").innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No boxes found for selected filters</p>
                        </div>
                    `;
                    return;
                }
                
                for (let box of boxesData) {
                    const { count: jobCount } = await db
                        .from("jobs")
                        .select("*", { count: "exact", head: true })
                        .eq("box_id", box.id);
                        
                    const { count: serialCount } = await db
                        .from("serials")
                        .select("*", { count: "exact", head: true })
                        .eq("box_id", box.id);
                        
                    box.jobCount = jobCount || 0;
                    box.serialCount = serialCount || 0;
                }
                
                renderBoxesList(boxesData);
            } catch (error) {
                showAlert("Error loading boxes: " + error.message, "error");
            } finally {
                showLoading(false);
            }
        }

        function renderBoxesList(boxesData) {
            const container = document.getElementById("exportResults");
            
            let html = `<div class="card"><h3 style="margin-bottom: 16px; color: var(--text-primary);">Select a Box</h3><div class="box-list">`;
            
            boxesData.forEach(box => {
                const closedDate = box.status === 'closed' && box.closed_at 
                    ? ` ‚Ä¢ Closed: ${new Date(box.closed_at).toLocaleDateString()}` 
                    : '';
                    
                html += `
                    <div class="box-item" onclick="selectBoxForExport(${box.id}); generateExportPreview();">
                        <div class="box-info">
                            <div class="box-id">${box.box_id}</div>
                            <div class="box-meta">${box.jobCount} jobs ‚Ä¢ ${box.serialCount} serials${closedDate}</div>
                        </div>
                        <span class="badge badge-${box.status}">${box.status}</span>
                    </div>
                `;
            });
            
            html += `</div></div>`;
            container.innerHTML = html;
        }

        async function selectBoxForExport(boxId) {
            document.querySelectorAll(".box-item").forEach(el => el.classList.remove("selected"));
            event.currentTarget.classList.add("selected");
            selectedExportBox = boxId;
        }

        async function generateExportPreview() {
            if (!selectedExportBox) return;
            
            showLoading(true);
            
            try {
                const { data: box } = await db
                    .from("boxes")
                    .select("*")
                    .eq("id", selectedExportBox)
                    .single();
                    
                const { data: jobs } = await db
                    .from("jobs")
                    .select("*")
                    .eq("box_id", selectedExportBox)
                    .order("created_at", { ascending: false });
                    
                let html = `
                    <div class="export-box-item">
                        <div class="export-box-header">
                            <div class="export-box-title">${box.box_id}</div>
                            <div class="export-box-subtitle">
                                Agent: ${box.agent} ‚Ä¢ Client: ${box.client}
                                ${box.status === 'closed' && box.closed_at ? ` ‚Ä¢ Closed: ${new Date(box.closed_at).toLocaleDateString()}` : ''}
                            </div>
                        </div>
                `;
                
                for (let job of jobs) {
                    const { data: serials } = await db
                        .from("serials")
                        .select("serial_number")
                        .eq("job_id", job.id)
                        .order("created_at", { ascending: true });
                        
                    html += `
                        <div class="job-section" onclick="toggleJobExpand(this)">
                            <div class="job-date">Created: ${new Date(job.created_at).toLocaleString()}</div>
                            <div class="job-header">
                                <span>Job: ${job.job_number} ‚Ä¢ Vendor: ${job.vendor} ‚Ä¢ ${serials.length} serials</span>
                                <span class="job-expand-icon">‚ñº</span>
                            </div>
                            <div class="serial-grid">
                    `;
                    
                    serials.forEach((serial, index) => {
                        const barcodeId = `barcode-${selectedExportBox}-${Date.now()}-${index}`;
                        html += `
                            <div class="serial-item">
                                <div class="serial-number">${serial.serial_number}</div>
                                <div class="barcode-container">
                                    <svg class="barcode-svg" data-serial="${serial.serial_number}" data-id="${barcodeId}"></svg>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                }
                
                html += `
                    </div>
                    <div style="text-align: center; margin-top: 24px;">
                        <button class="btn btn-primary" onclick="window.print()">üìÑ Generate PDF</button>
                        <button class="btn btn-ghost" onclick="clearExportPreview()" style="margin-left: 12px;">Close</button>
                    </div>
                `;
                
                const preview = document.getElementById("exportPreview");
                preview.innerHTML = html;
                preview.classList.remove("hidden");
                
                setTimeout(() => {
                    document.querySelectorAll(".barcode-svg").forEach(svg => {
                        const serial = svg.getAttribute("data-serial");
                        const id = svg.getAttribute("data-id");
                        
                        try {
                            svg.setAttribute("id", id);
                            JsBarcode(`#${id}`, serial, {
                                format: "CODE128",
                                width: 2,
                                height: 50,
                                displayValue: false,
                                margin: 5
                            });
                        } catch (e) {
                            console.error("Barcode error:", e);
                        }
                    });
                }, 100);
                
                showAlert("‚úì Export preview generated", "success");
            } catch (error) {
                showAlert("Error generating export: " + error.message, "error");
            } finally {
                showLoading(false);
            }
        }

        function toggleJobExpand(element) {
            element.classList.toggle('expanded');
        }

        function clearExportPreview() {
            document.getElementById("exportPreview").innerHTML = "";
            document.getElementById("exportPreview").classList.add("hidden");
            document.getElementById("exportBoxSelection").classList.add("hidden");
            selectedExportBox = null;
            document.querySelectorAll(".box-item").forEach(el => el.classList.remove("selected"));
        }

        function clearExportPage() {
            document.getElementById("filterAgent").value = "";
            document.getElementById("filterExportClient").value = "";
            resetExportResults();
            clearExportPreview();
        }
    </script>
</body>
</html>
