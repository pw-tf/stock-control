<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - Stock Submission</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="icons.js"></script>
    <script src="utils.js"></script>
</head>
<body>
    <div class="login-wrapper">
        <div class="login-container">
            <div class="login-header">
                <div class="login-logo"><i data-lucide="package" width="32" height="32"></i></div>
                <h1>Stock Submission</h1>
                <p>Sign in to manage your inventory</p>
            </div>
            
            <div class="login-content">
                <div id="alertContainer"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="email">Email Address</label>
                        <input 
                            type="email" 
                            id="email" 
                            class="form-input" 
                            required 
                            autocomplete="email" 
                            placeholder="you@company.com"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="password">Password</label>
                        <input 
                            type="password" 
                            id="password" 
                            class="form-input" 
                            required 
                            autocomplete="current-password" 
                            placeholder="Enter your password"
                        >
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="loginBtn" style="width: 100%; margin-top: 8px;">
                        <span id="loginText">Sign In</span>
                        <div class="spinner loading-spinner-inline" id="loginSpinner" style="display: none;"></div>
                    </button>
                </form>
                
                <div class="login-footer">
                    <a href="#" onclick="resetPassword(event)">Forgot your password?</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const db = window.supabase.createClient(
            "https://lfydtctndrzzdyavmlva.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxmeWR0Y3RuZHJ6emR5YXZtbHZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0Nzc5MTksImV4cCI6MjA4MzA1MzkxOX0.O7dL6Gl-Re1yKEixO_BRa-goj67os6riy15hRIE4nqY"
        );

        // Check if user is already logged in
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                window.location.href = 'dashboard.html';
            }
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginText = document.getElementById('loginText');
            const loginSpinner = document.getElementById('loginSpinner');
            
            // Show loading state
            loginBtn.disabled = true;
            loginText.style.display = 'none';
            loginSpinner.style.display = 'block';
            
            try {
                // Sign in with Supabase Auth
                const { data: authData, error: authError } = await db.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (authError) throw authError;
                
                // Get user role
                const { data: roleData, error: roleError } = await db
                    .from('user_roles')
                    .select('role, agent_id')
                    .eq('user_id', authData.user.id)
                    .single();
                
                if (roleError) {
                    // Account exists but signup was incomplete
                    await db.auth.signOut();
                    throw new Error('Account setup incomplete. Please contact your administrator for a new invitation link.');
                }
                
                // Store role and agent_id in session storage
                sessionStorage.setItem('userRole', roleData.role);
                sessionStorage.setItem('userAgent', roleData.agent_id);
                sessionStorage.setItem('userEmail', email);
                
                showAlert('Login successful! Redirecting...', 'success');
                
                // Redirect based on role
                setTimeout(() => {
                    if (roleData.role === 'merchant') {
                        window.location.href = 'guides.html';
                    } else {
                        window.location.href = 'dashboard.html';
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Login error:', error);
                showAlert(error.message || 'Invalid email or password', 'error');
                
                // Reset button state
                loginBtn.disabled = false;
                loginText.style.display = 'inline';
                loginSpinner.style.display = 'none';
            }
        });

        async function resetPassword(e) {
            e.preventDefault();
            const email = prompt('Enter your email address:');
            if (!email) return;
            
            try {
                const { error } = await db.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/reset-password.html'
                });
                
                if (error) throw error;
                
                showAlert('Password reset email sent! Check your inbox.', 'success');
            } catch (error) {
                console.error('Password reset error:', error);
                showAlert('Error: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
