<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Reports - Admin</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>
    <script src="sidebar.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- Main Container -->
    <div class="app-wrapper">
        <div class="container container-wide">
            <div class="header">
                <div class="header-content">
                    <div class="header-icon">ðŸ“Š</div>
                    <div>
                        <h1>Shift Reports</h1>
                        <div class="header-subtitle">View and manage all technician shifts</div>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <div id="alertContainer"></div>
                
                <!-- Technician Filter -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">View Shifts For</label>
                        <select id="shiftTechnicianFilter" class="form-select">
                            <option value="">All Technicians</option>
                        </select>
                    </div>
                </div>
                
                <!-- Date Range Filter -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="filter-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">From Date</label>
                            <input type="date" id="shiftDateFrom" class="form-input">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">To Date</label>
                            <input type="date" id="shiftDateTo" class="form-input">
                        </div>
                    </div>
                    <div class="button-group" style="margin-top: 16px;">
                        <button class="btn btn-primary" id="loadShiftsBtn" onclick="loadShiftsAdmin()">Load Shifts</button>
                        <button class="btn btn-secondary" id="downloadShiftsBtn" onclick="downloadShiftsAdmin()" disabled>Download CSV</button>
                    </div>
                </div>
                
                <!-- Shift Summary -->
                <div class="card" id="shiftAdminSummary" style="display: none; margin-bottom: 24px;">
                    <h3 style="margin-bottom: 16px;">Summary</h3>
                    <div class="shift-summary-grid">
                        <div class="shift-summary-stat">
                            <div class="shift-summary-value" id="adminSummaryShifts">0</div>
                            <div class="shift-summary-label">Total Shifts</div>
                        </div>
                        <div class="shift-summary-stat">
                            <div class="shift-summary-value" id="adminSummaryHours">0h</div>
                            <div class="shift-summary-label">Hours Worked</div>
                        </div>
                        <div class="shift-summary-stat">
                            <div class="shift-summary-value" id="adminSummaryKms">0 km</div>
                            <div class="shift-summary-label">Distance Travelled</div>
                        </div>
                        <div class="shift-summary-stat">
                            <div class="shift-summary-value" id="adminSummaryJobs">0</div>
                            <div class="shift-summary-label">Total Jobs</div>
                        </div>
                    </div>
                </div>
                
                <!-- Shifts List -->
                <div class="card">
                    <div id="shiftsAdminContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ“Š</div>
                            <p>Select a date range and click "Load Shifts" to view shift reports</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shift Detail Modal -->
    <div class="modal" id="shiftDetailAdminModal">
        <div class="modal-content" style="max-width: 560px;">
            <div class="modal-header">
                <h3>ðŸ“Š Shift Details</h3>
            </div>
            <div id="shiftDetailAdminContent">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="closeShiftDetailAdminModal()">Close</button>
                <button type="button" class="btn btn-secondary" onclick="copyShiftDetailAdmin()">ðŸ“‹ Copy</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allShiftsAdmin = [];
        let selectedShiftDetailAdmin = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            currentUser = await initAuth('manager');
            if (!currentUser) return;
            
            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            document.getElementById('shiftDateTo').value = today.toISOString().split('T')[0];
            document.getElementById('shiftDateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
            
            await loadTechniciansForFilter();
            
            // Check for user parameter in URL and auto-load their shifts
            const urlParams = new URLSearchParams(window.location.search);
            const userIdParam = urlParams.get('user');
            
            if (userIdParam) {
                // Set the technician filter to the specified user
                document.getElementById('shiftTechnicianFilter').value = userIdParam;
                // Auto-load their shifts
                await loadShiftsAdmin();
            }
            
            // Initialize sidebar
            initSidebar(currentUser);
            
            showLoading(false);
        });
        
        function showLoading(show) {
            document.getElementById("loading").classList.toggle("active", show);
        }
        
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            
            const icons = { success: 'âœ“', error: 'âœ•', warning: 'âš ', info: 'â„¹' };
            alert.innerHTML = `<span class="alert-icon">${icons[type] || 'â„¹'}</span><span>${message}</span>`;
            
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }
        
        async function loadTechniciansForFilter() {
            try {
                const { data, error } = await db
                    .from('user_roles')
                    .select('user_id, email, agent_id')
                    .eq('shifts_enabled', true)
                    .order('agent_id', { ascending: true });
                
                if (error) throw error;
                
                const select = document.getElementById('shiftTechnicianFilter');
                select.innerHTML = '<option value="">All Technicians</option>';
                
                if (data && data.length > 0) {
                    data.forEach(tech => {
                        const option = document.createElement('option');
                        option.value = tech.user_id;
                        option.textContent = `Agent ${tech.agent_id} - ${tech.email}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading technicians:', error);
            }
        }
        
        async function loadShiftsAdmin() {
            const dateFrom = document.getElementById('shiftDateFrom').value;
            const dateTo = document.getElementById('shiftDateTo').value;
            const techFilter = document.getElementById('shiftTechnicianFilter').value;
            
            if (!dateFrom || !dateTo) {
                showAlert('Please select both from and to dates', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                let query = db
                    .from('shifts')
                    .select('*')
                    .eq('status', 'completed')
                    .gte('start_time', new Date(dateFrom).toISOString())
                    .lte('start_time', new Date(dateTo + 'T23:59:59').toISOString())
                    .order('start_time', { ascending: false });
                
                if (techFilter) {
                    query = query.eq('user_id', techFilter);
                }
                
                const { data: shifts, error } = await query;
                
                if (error) throw error;
                
                allShiftsAdmin = shifts || [];
                
                // Get user emails for display
                const userIds = [...new Set(allShiftsAdmin.map(s => s.user_id))];
                const { data: users } = await db
                    .from('user_roles')
                    .select('user_id, email, agent_id')
                    .in('user_id', userIds);
                
                const userMap = {};
                users?.forEach(u => {
                    userMap[u.user_id] = { email: u.email, agent_id: u.agent_id };
                });
                
                // Calculate jobs for each shift
                for (let shift of allShiftsAdmin) {
                    shift.userInfo = userMap[shift.user_id] || { email: 'Unknown', agent_id: 'N/A' };
                    
                    const { count } = await db
                        .from('jobs')
                        .select('*', { count: 'exact', head: true })
                        .eq('shift_id', shift.id);
                    
                    shift.systemJobs = count || 0;
                    shift.totalJobs = shift.systemJobs + (shift.extra_jobs || 0);
                }
                
                renderShiftsAdmin();
                renderSummaryAdmin();
                
                document.getElementById('downloadShiftsBtn').disabled = allShiftsAdmin.length === 0;
                
            } catch (error) {
                console.error('Error loading shifts:', error);
                showAlert('Error loading shifts: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function renderShiftsAdmin() {
            const container = document.getElementById('shiftsAdminContainer');
            
            if (!allShiftsAdmin || allShiftsAdmin.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“­</div>
                        <p>No completed shifts found for the selected date range</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="shifts-list">';
            
            allShiftsAdmin.forEach(shift => {
                const startTime = new Date(shift.start_time);
                const endTime = new Date(shift.end_time);
                const hoursWorked = (endTime - startTime) / (1000 * 60 * 60);
                const hours = Math.floor(hoursWorked);
                const minutes = Math.round((hoursWorked - hours) * 60);
                const kmsTravelled = shift.end_kms - shift.start_kms;
                
                const dateStr = startTime.toLocaleDateString('en-AU', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                
                const timeStr = `${startTime.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: true })} - ${endTime.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: true })}`;
                
                html += `
                    <div class="shift-card" onclick="showShiftDetailAdmin(${shift.id})">
                        <div class="shift-card-header">
                            <div class="shift-card-date">${dateStr}</div>
                            <div class="shift-card-agent">Agent ${shift.userInfo.agent_id}</div>
                        </div>
                        <div class="shift-card-time">${timeStr}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 12px;">${shift.userInfo.email}</div>
                        <div class="shift-card-stats">
                            <div class="shift-card-stat">
                                <span class="shift-card-stat-value">${hours}h ${minutes}m</span>
                                <span class="shift-card-stat-label">Duration</span>
                            </div>
                            <div class="shift-card-stat">
                                <span class="shift-card-stat-value">${kmsTravelled.toLocaleString()} km</span>
                                <span class="shift-card-stat-label">Distance</span>
                            </div>
                            <div class="shift-card-stat">
                                <span class="shift-card-stat-value">${shift.totalJobs}</span>
                                <span class="shift-card-stat-label">Jobs</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderSummaryAdmin() {
            if (!allShiftsAdmin || allShiftsAdmin.length === 0) {
                document.getElementById('shiftAdminSummary').style.display = 'none';
                return;
            }
            
            let totalHours = 0;
            let totalKms = 0;
            let totalJobs = 0;
            
            allShiftsAdmin.forEach(shift => {
                const startTime = new Date(shift.start_time);
                const endTime = new Date(shift.end_time);
                totalHours += (endTime - startTime) / (1000 * 60 * 60);
                totalKms += shift.end_kms - shift.start_kms;
                totalJobs += shift.totalJobs;
            });
            
            const hours = Math.floor(totalHours);
            const minutes = Math.round((totalHours - hours) * 60);
            
            document.getElementById('adminSummaryShifts').textContent = allShiftsAdmin.length;
            document.getElementById('adminSummaryHours').textContent = `${hours}h ${minutes}m`;
            document.getElementById('adminSummaryKms').textContent = `${totalKms.toLocaleString()} km`;
            document.getElementById('adminSummaryJobs').textContent = totalJobs;
            
            document.getElementById('shiftAdminSummary').style.display = 'block';
        }
        
        function showShiftDetailAdmin(shiftId) {
            const shift = allShiftsAdmin.find(s => s.id === shiftId);
            if (!shift) return;
            
            selectedShiftDetailAdmin = shift;
            
            const startTime = new Date(shift.start_time);
            const endTime = new Date(shift.end_time);
            const hoursWorked = (endTime - startTime) / (1000 * 60 * 60);
            const hours = Math.floor(hoursWorked);
            const minutes = Math.round((hoursWorked - hours) * 60);
            const kmsTravelled = shift.end_kms - shift.start_kms;
            
            const dateStr = startTime.toLocaleDateString('en-AU', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            const html = `
                <div class="shift-report-card">
                    <div class="shift-report-header">
                        <div class="shift-report-date">${dateStr}</div>
                        <div class="shift-report-agent">Agent ${shift.agent_id}</div>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 16px;">${shift.userInfo.email}</div>
                    
                    <div class="shift-report-grid">
                        <div class="shift-report-stat">
                            <div class="shift-report-stat-value">${hours}h ${minutes}m</div>
                            <div class="shift-report-stat-label">Hours Worked</div>
                            <div class="shift-report-stat-detail">${formatDateTime(shift.start_time)} â†’ ${formatDateTime(shift.end_time)}</div>
                        </div>
                        
                        <div class="shift-report-stat">
                            <div class="shift-report-stat-value">${kmsTravelled.toLocaleString()} km</div>
                            <div class="shift-report-stat-label">Distance Travelled</div>
                            <div class="shift-report-stat-detail">${shift.start_kms.toLocaleString()} â†’ ${shift.end_kms.toLocaleString()} km</div>
                        </div>
                        
                        <div class="shift-report-stat">
                            <div class="shift-report-stat-value">${shift.totalJobs}</div>
                            <div class="shift-report-stat-label">Total Jobs</div>
                            <div class="shift-report-stat-detail">${shift.systemJobs} logged + ${shift.extra_jobs || 0} extra</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('shiftDetailAdminContent').innerHTML = html;
            document.getElementById('shiftDetailAdminModal').classList.add('active');
        }
        
        function closeShiftDetailAdminModal() {
            document.getElementById('shiftDetailAdminModal').classList.remove('active');
            selectedShiftDetailAdmin = null;
        }
        
        function formatDateTime(date) {
            return new Date(date).toLocaleString('en-AU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }
        
        function copyShiftDetailAdmin() {
            if (!selectedShiftDetailAdmin) return;
            
            const shift = selectedShiftDetailAdmin;
            const startTime = new Date(shift.start_time);
            const endTime = new Date(shift.end_time);
            const hoursWorked = (endTime - startTime) / (1000 * 60 * 60);
            const hours = Math.floor(hoursWorked);
            const minutes = Math.round((hoursWorked - hours) * 60);
            const kmsTravelled = shift.end_kms - shift.start_kms;
            
            const dateStr = startTime.toLocaleDateString('en-AU', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            const text = `SHIFT REPORT - ${dateStr}
Agent: ${shift.agent_id}
Technician: ${shift.userInfo.email}

TIME
Start: ${formatDateTime(shift.start_time)}
End: ${formatDateTime(shift.end_time)}
Duration: ${hours}h ${minutes}m (${hoursWorked.toFixed(2)} hours)

KILOMETRES
Start: ${shift.start_kms.toLocaleString()} km
End: ${shift.end_kms.toLocaleString()} km
Travelled: ${kmsTravelled.toLocaleString()} km

JOBS
System Logged: ${shift.systemJobs}
Extra Jobs: ${shift.extra_jobs || 0}
Total: ${shift.totalJobs}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showAlert('âœ“ Report copied to clipboard', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showAlert('Failed to copy report', 'error');
            });
        }
        
        function downloadShiftsAdmin() {
            if (!allShiftsAdmin || allShiftsAdmin.length === 0) {
                showAlert('No shifts to export', 'warning');
                return;
            }
            
            let csvContent = 'Date,Agent,Email,Start Time,End Time,Hours (Decimal),Start KM,End KM,KM Travelled,System Jobs,Extra Jobs,Total Jobs\n';
            
            allShiftsAdmin.forEach(shift => {
                const startTime = new Date(shift.start_time);
                const endTime = new Date(shift.end_time);
                const hoursWorked = (endTime - startTime) / (1000 * 60 * 60);
                const kmsTravelled = shift.end_kms - shift.start_kms;
                
                const dateStr = startTime.toLocaleDateString('en-AU');
                
                csvContent += `"${dateStr}","${shift.agent_id}","${shift.userInfo.email}","${formatDateTime(shift.start_time)}","${formatDateTime(shift.end_time)}",${hoursWorked.toFixed(2)},${shift.start_kms},${shift.end_kms},${kmsTravelled},${shift.systemJobs},${shift.extra_jobs || 0},${shift.totalJobs}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const dateFrom = document.getElementById('shiftDateFrom').value;
            const dateTo = document.getElementById('shiftDateTo').value;
            const filename = `all-shifts-${dateFrom}-to-${dateTo}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('âœ“ CSV downloaded', 'success');
        }
    </script>
</body>
</html>
