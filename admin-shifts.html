<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Reports - Admin</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>
    <script src="sidebar.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- Main Container -->
    <div class="app-wrapper">
        <div class="container container-wide">
            <div class="header">
                <div class="header-content">
                    <div class="header-icon">ðŸ“Š</div>
                    <div>
                        <h1>Shift Reports</h1>
                        <div class="header-subtitle">View and manage all technician shifts</div>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <div id="alertContainer"></div>
                
                <!-- Technician Filter -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">View Shifts For</label>
                        <select id="shiftTechnicianFilter" class="form-select">
                            <option value="">All Technicians</option>
                        </select>
                    </div>
                </div>
                
                <!-- Date Range Filter -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="filter-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">From Date</label>
                            <input type="date" id="shiftDateFrom" class="form-input">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">To Date</label>
                            <input type="date" id="shiftDateTo" class="form-input">
                        </div>
                    </div>
                    <div class="button-group" style="margin-top: 16px;">
                        <button class="btn btn-primary" id="loadShiftsBtn">Load Shifts</button>
                        <button class="btn btn-secondary" id="downloadShiftsBtn" onclick="downloadShiftsCSV()" disabled>Download CSV</button>
                    </div>
                </div>
                
                <!-- Shift Summary -->
                <div class="card" id="shiftSummary" style="display: none; margin-bottom: 24px;">
                    <h3 style="margin-bottom: 16px;">Summary</h3>
                    <div class="shift-summary-grid">
                        <div class="shift-summary-stat">
                            <div class="shift-summary-value" id="summaryShifts">0</div>
                            <div class="shift-summary-label">Total Shifts</div>
                        </div>
                        <div class="shift-summary-stat">
                            <div class="shift-summary-value" id="summaryHours">0h</div>
                            <div class="shift-summary-label">Hours Worked</div>
                        </div>
                        <div class="shift-summary-stat">
                            <div class="shift-summary-value" id="summaryKms">0 km</div>
                            <div class="shift-summary-label">Distance Travelled</div>
                        </div>
                        <div class="shift-summary-stat">
                            <div class="shift-summary-value" id="summaryJobs">0</div>
                            <div class="shift-summary-label">Total Jobs</div>
                        </div>
                    </div>
                </div>
                
                <!-- Shifts List -->
                <div class="card">
                    <div id="shiftsContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ“Š</div>
                            <p>Select a date range and click "Load Shifts" to view shift reports</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shift Detail Modal -->
    <div class="modal" id="shiftDetailModal">
        <div class="modal-content" style="max-width: 560px;">
            <div class="modal-header">
                <h3>ðŸ“Š Shift Details</h3>
            </div>
            <div id="shiftDetailContent">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="closeShiftDetailModal()">Close</button>
                <button type="button" class="btn btn-secondary" onclick="copyShiftDetail()">ðŸ“‹ Copy</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allShifts = [];
        let allClients = [];
        let selectedShiftDetail = null;
        
        // Helper function to format date for input fields (avoids UTC timezone issues)
        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Helper function to format datetime for display
        function formatDateTime(date) {
            return new Date(date).toLocaleString('en-AU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            currentUser = await initAuth('manager');
            if (!currentUser) return;
            
            // Set default date range (today)
            const today = new Date();
            document.getElementById('shiftDateTo').value = formatLocalDate(today);
            document.getElementById('shiftDateFrom').value = formatLocalDate(today);
            
            await loadTechniciansForFilter();
            
            // Check for user parameter in URL and auto-load their shifts
            const urlParams = new URLSearchParams(window.location.search);
            const userIdParam = urlParams.get('user');
            
            if (userIdParam) {
                document.getElementById('shiftTechnicianFilter').value = userIdParam;
                await loadShifts();
            }
            
            // Setup load button
            document.getElementById('loadShiftsBtn').addEventListener('click', loadShifts);
            
            // Initialize sidebar
            initSidebar(currentUser);
            
            showLoading(false);
        });
        
        function showLoading(show) {
            document.getElementById("loading").classList.toggle("active", show);
        }
        
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            
            const icons = { success: 'âœ“', error: 'âœ•', warning: 'âš ', info: 'â„¹' };
            alert.innerHTML = `<span class="alert-icon">${icons[type] || 'â„¹'}</span><span>${message}</span>`;
            
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }
        
        async function loadTechniciansForFilter() {
            try {
                const { data, error } = await db
                    .from('user_roles')
                    .select('user_id, email, agent_id')
                    .eq('shifts_enabled', true)
                    .order('agent_id', { ascending: true });
                
                if (error) throw error;
                
                const select = document.getElementById('shiftTechnicianFilter');
                select.innerHTML = '<option value="">All Technicians</option>';
                
                if (data && data.length > 0) {
                    data.forEach(tech => {
                        const option = document.createElement('option');
                        option.value = tech.user_id;
                        option.textContent = `Agent ${tech.agent_id} - ${tech.email}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading technicians:', error);
            }
        }
        
        async function loadShifts() {
            const dateFrom = document.getElementById('shiftDateFrom').value;
            const dateTo = document.getElementById('shiftDateTo').value;
            const techFilter = document.getElementById('shiftTechnicianFilter').value;
            
            if (!dateFrom || !dateTo) {
                showAlert('Please select both from and to dates', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                let query = db
                    .from('shifts')
                    .select('*')
                    .eq('status', 'completed')
                    .gte('start_time', new Date(dateFrom + 'T00:00:00').toISOString())
                    .lte('start_time', new Date(dateTo + 'T23:59:59').toISOString())
                    .order('start_time', { ascending: false });
                
                // Filter by specific technician if selected
                if (techFilter) {
                    query = query.eq('user_id', techFilter);
                }
                
                const { data: shifts, error } = await query;
                
                if (error) throw error;
                
                allShifts = shifts || [];
                
                // Load all clients for dynamic columns
                const { data: clientsData } = await db
                    .from('clients')
                    .select('client_id')
                    .order('client_id', { ascending: true });
                
                allClients = clientsData ? clientsData.map(c => c.client_id) : [];
                
                // Get user emails for display
                const userIds = [...new Set(allShifts.map(s => s.user_id))];
                let userMap = {};
                
                if (userIds.length > 0) {
                    const { data: users } = await db
                        .from('user_roles')
                        .select('user_id, email, agent_id')
                        .in('user_id', userIds);
                    
                    users?.forEach(u => {
                        userMap[u.user_id] = { email: u.email, agent_id: u.agent_id };
                    });
                }
                
                // Calculate jobs for each shift (broken down by client)
                for (let shift of allShifts) {
                    shift.userInfo = userMap[shift.user_id] || { email: 'Unknown', agent_id: 'N/A' };
                    
                    const { data: boxes } = await db
                        .from('boxes')
                        .select('id, client')
                        .eq('agent', shift.agent_id);
                    
                    // Initialize job counts per client
                    shift.jobsByClient = {};
                    allClients.forEach(client => {
                        shift.jobsByClient[client] = 0;
                    });
                    
                    if (boxes && boxes.length > 0) {
                        // Group boxes by client
                        const boxesByClient = {};
                        boxes.forEach(box => {
                            if (!boxesByClient[box.client]) {
                                boxesByClient[box.client] = [];
                            }
                            boxesByClient[box.client].push(box.id);
                        });
                        
                        // Count jobs per client
                        let totalSystemJobs = 0;
                        for (const client of Object.keys(boxesByClient)) {
                            const clientBoxIds = boxesByClient[client];
                            const { count } = await db
                                .from('jobs')
                                .select('*', { count: 'exact', head: true })
                                .in('box_id', clientBoxIds)
                                .gte('created_at', shift.start_time)
                                .lte('created_at', shift.end_time);
                            
                            shift.jobsByClient[client] = count || 0;
                            totalSystemJobs += count || 0;
                        }
                        shift.systemJobs = totalSystemJobs;
                    } else {
                        shift.systemJobs = 0;
                    }
                    shift.totalJobs = shift.systemJobs + (shift.extra_jobs || 0);
                }
                
                renderShifts();
                renderSummary();
                
                document.getElementById('downloadShiftsBtn').disabled = allShifts.length === 0;
                
            } catch (error) {
                console.error('Error loading shifts:', error);
                showAlert('Error loading shifts: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function renderShifts() {
            const container = document.getElementById('shiftsContainer');
            
            if (!allShifts || allShifts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“­</div>
                        <p>No completed shifts found for the selected date range</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="shifts-list">';
            
            allShifts.forEach(shift => {
                const startTime = new Date(shift.start_time);
                const endTime = new Date(shift.end_time);
                const hoursWorked = (endTime - startTime) / (1000 * 60 * 60);
                const hours = Math.floor(hoursWorked);
                const minutes = Math.round((hoursWorked - hours) * 60);
                const kmsTravelled = shift.end_kms - shift.start_kms;
                
                const dateStr = startTime.toLocaleDateString('en-AU', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                
                const timeStr = `${startTime.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: true })} - ${endTime.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: true })}`;
                
                html += `
                    <div class="shift-card" onclick="showShiftDetail(${shift.id})">
                        <div class="shift-card-header">
                            <div class="shift-card-date">${dateStr}</div>
                            <div class="shift-card-agent">Agent ${shift.userInfo.agent_id}</div>
                        </div>
                        <div class="shift-card-time">${timeStr}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 12px;">${shift.userInfo.email}</div>
                        <div class="shift-card-stats">
                            <div class="shift-card-stat">
                                <span class="shift-card-stat-value">${hours}h ${minutes}m</span>
                                <span class="shift-card-stat-label">Duration</span>
                            </div>
                            <div class="shift-card-stat">
                                <span class="shift-card-stat-value">${kmsTravelled.toLocaleString()} km</span>
                                <span class="shift-card-stat-label">Distance</span>
                            </div>
                            <div class="shift-card-stat">
                                <span class="shift-card-stat-value">${shift.totalJobs}</span>
                                <span class="shift-card-stat-label">Jobs</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderSummary() {
            if (!allShifts || allShifts.length === 0) {
                document.getElementById('shiftSummary').style.display = 'none';
                return;
            }
            
            let totalHours = 0;
            let totalKms = 0;
            let totalJobs = 0;
            
            allShifts.forEach(shift => {
                const startTime = new Date(shift.start_time);
                const endTime = new Date(shift.end_time);
                totalHours += (endTime - startTime) / (1000 * 60 * 60);
                totalKms += shift.end_kms - shift.start_kms;
                totalJobs += shift.totalJobs;
            });
            
            const hours = Math.floor(totalHours);
            const minutes = Math.round((totalHours - hours) * 60);
            
            document.getElementById('summaryShifts').textContent = allShifts.length;
            document.getElementById('summaryHours').textContent = `${hours}h ${minutes}m`;
            document.getElementById('summaryKms').textContent = `${totalKms.toLocaleString()} km`;
            document.getElementById('summaryJobs').textContent = totalJobs;
            
            document.getElementById('shiftSummary').style.display = 'block';
        }
        
        function showShiftDetail(shiftId) {
            const shift = allShifts.find(s => s.id === shiftId);
            if (!shift) return;
            
            selectedShiftDetail = shift;
            
            const startTime = new Date(shift.start_time);
            const endTime = new Date(shift.end_time);
            const hoursWorked = (endTime - startTime) / (1000 * 60 * 60);
            const hours = Math.floor(hoursWorked);
            const minutes = Math.round((hoursWorked - hours) * 60);
            const kmsTravelled = shift.end_kms - shift.start_kms;
            
            const dateStr = startTime.toLocaleDateString('en-AU', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            const html = `
                <div class="shift-report-card">
                    <div class="shift-report-header">
                        <div class="shift-report-date">${dateStr}</div>
                        <div class="shift-report-agent">Agent ${shift.agent_id}</div>
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 16px;">${shift.userInfo.email}</div>
                    
                    <div class="shift-report-grid">
                        <div class="shift-report-stat">
                            <div class="shift-report-stat-value">${hours}h ${minutes}m</div>
                            <div class="shift-report-stat-label">Hours Worked</div>
                            <div class="shift-report-stat-detail">${formatDateTime(shift.start_time)} â†’ ${formatDateTime(shift.end_time)}</div>
                        </div>
                        
                        <div class="shift-report-stat">
                            <div class="shift-report-stat-value">${kmsTravelled.toLocaleString()} km</div>
                            <div class="shift-report-stat-label">Distance Travelled</div>
                            <div class="shift-report-stat-detail">${shift.start_kms.toLocaleString()} â†’ ${shift.end_kms.toLocaleString()} km</div>
                        </div>
                        
                        <div class="shift-report-stat">
                            <div class="shift-report-stat-value">${shift.totalJobs}</div>
                            <div class="shift-report-stat-label">Total Jobs</div>
                            <div class="shift-report-stat-detail">${shift.systemJobs} logged + ${shift.extra_jobs || 0} extra</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('shiftDetailContent').innerHTML = html;
            document.getElementById('shiftDetailModal').classList.add('active');
        }
        
        function closeShiftDetailModal() {
            document.getElementById('shiftDetailModal').classList.remove('active');
            selectedShiftDetail = null;
        }
        
        function copyShiftDetail() {
            if (!selectedShiftDetail) return;
            
            const shift = selectedShiftDetail;
            const startTime = new Date(shift.start_time);
            const endTime = new Date(shift.end_time);
            const hoursWorked = (endTime - startTime) / (1000 * 60 * 60);
            const hours = Math.floor(hoursWorked);
            const minutes = Math.round((hoursWorked - hours) * 60);
            const kmsTravelled = shift.end_kms - shift.start_kms;
            
            const dateStr = startTime.toLocaleDateString('en-AU', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            const text = `SHIFT REPORT - ${dateStr}
Agent: ${shift.agent_id}
Technician: ${shift.userInfo.email}

TIME
Start: ${formatDateTime(shift.start_time)}
End: ${formatDateTime(shift.end_time)}
Duration: ${hours}h ${minutes}m (${hoursWorked.toFixed(2)} hours)

KILOMETRES
Start: ${shift.start_kms.toLocaleString()} km
End: ${shift.end_kms.toLocaleString()} km
Travelled: ${kmsTravelled.toLocaleString()} km

JOBS
System Logged: ${shift.systemJobs}
Extra Jobs: ${shift.extra_jobs || 0}
Total: ${shift.totalJobs}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showAlert('âœ“ Report copied to clipboard', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showAlert('Failed to copy report', 'error');
            });
        }
        
        function getTimeMultiplier(date) {
            const dayOfWeek = new Date(date).getDay();
            if (dayOfWeek === 0) return 2.0;   // Sunday
            if (dayOfWeek === 6) return 1.5;   // Saturday
            return 1.0;                         // Monday-Friday
        }
        
        function getTimeMultiplierLabel(date) {
            const dayOfWeek = new Date(date).getDay();
            if (dayOfWeek === 0) return '2x (Sun)';
            if (dayOfWeek === 6) return '1.5x (Sat)';
            return '1x';
        }
        
        function formatTimeHMM(decimalHours) {
            const hours = Math.floor(decimalHours);
            const minutes = Math.round((decimalHours - hours) * 60);
            return `${hours}:${String(minutes).padStart(2, '0')}`;
        }
        
        function escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const str = String(value);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        }
        
        function downloadShiftsCSV() {
            if (!allShifts || allShifts.length === 0) {
                showAlert('No shifts to export', 'warning');
                return;
            }
            
            // Build header row with dynamic client columns
            let headers = [
                'Date',
                'Start Time',
                'End Time',
                'Agent',
                'Email',
                'Total Time (h:mm)',
                'Total Time (decimal)',
                'Time Multiplier',
                'Adjusted Time (decimal)',
                'Start Km',
                'End Km',
                'Km Travelled'
            ];
            
            // Add dynamic client columns
            allClients.forEach(client => {
                headers.push(`Jobs - ${client}`);
            });
            
            // Add remaining columns
            headers.push('Extra Jobs');
            headers.push('Total Jobs');
            headers.push('Shift Notes');
            
            let csvContent = headers.join(',') + '\n';
            
            allShifts.forEach(shift => {
                const startTime = new Date(shift.start_time);
                const endTime = new Date(shift.end_time);
                const hoursWorked = (endTime - startTime) / (1000 * 60 * 60);
                const kmsTravelled = shift.end_kms - shift.start_kms;
                const multiplier = getTimeMultiplier(shift.start_time);
                const adjustedTime = hoursWorked * multiplier;
                
                const dateStr = startTime.toLocaleDateString('en-AU');
                
                let row = [
                    dateStr,
                    formatDateTime(shift.start_time),
                    formatDateTime(shift.end_time),
                    shift.agent_id,
                    shift.userInfo?.email || '',
                    formatTimeHMM(hoursWorked),
                    hoursWorked.toFixed(2),
                    getTimeMultiplierLabel(shift.start_time),
                    adjustedTime.toFixed(2),
                    shift.start_kms,
                    shift.end_kms,
                    kmsTravelled
                ];
                
                // Add job counts for each client
                allClients.forEach(client => {
                    row.push(shift.jobsByClient?.[client] || 0);
                });
                
                // Add remaining data
                row.push(shift.extra_jobs || 0);
                row.push(shift.totalJobs);
                row.push(escapeCSV(shift.shift_notes || ''));
                
                csvContent += row.map(val => escapeCSV(val)).join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const dateFrom = document.getElementById('shiftDateFrom').value;
            const dateTo = document.getElementById('shiftDateTo').value;
            const filename = `shifts-${dateFrom}-to-${dateTo}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('âœ“ CSV downloaded', 'success');
        }
    </script>
</body>
</html>
