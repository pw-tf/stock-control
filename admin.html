<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Stock Submission</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>
</head>
<body>
    <!-- Hamburger Button -->
    <button class="hamburger-btn visible" id="hamburgerBtn">
        <span></span>
        <span></span>
        <span></span>
    </button>
    
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Navigation</h2>
            <button class="sidebar-close" id="sidebarClose">√ó</button>
        </div>
        <div class="sidebar-menu">
            <div class="sidebar-menu-item" onclick="window.location.href='dashboard.html'">
                <span>üìã</span>
                <span>Stock Entry</span>
            </div>
            <div class="sidebar-menu-item" onclick="window.location.href='dashboard.html#export'">
                <span>üìä</span>
                <span>View Boxes</span>
            </div>
            <div class="sidebar-menu-item active">
                <span>‚öôÔ∏è</span>
                <span>Admin Panel</span>
            </div>
            <div class="sidebar-menu-item" onclick="logout()">
                <span>üö™</span>
                <span>Sign Out</span>
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="app-wrapper">
        <div class="container container-wide">
            <div class="header">
                <div class="header-content">
                    <div class="header-icon">‚öôÔ∏è</div>
                    <div>
                        <h1>Admin Panel</h1>
                        <div class="header-subtitle">Manage users, agents, clients & vendors</div>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <div id="alertContainer"></div>
                
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" data-tab="users">Users</button>
                    <button class="tab" data-tab="agents">Agents</button>
                    <button class="tab" data-tab="clients">Clients</button>
                    <button class="tab" data-tab="vendors">Vendors</button>
                </div>
                
                <!-- Users Tab -->
                <div class="tab-content active" id="users-tab">
                    <div class="section-header">
                        <h2>User Management</h2>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Agent ID</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="5" style="text-align: center; color: var(--text-muted); padding: 40px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="help-box">
                        <p>
                            <strong>To add a new user:</strong><br>
                            1. Go to Supabase ‚Üí Authentication ‚Üí Users ‚Üí Add User<br>
                            2. Create the user account and copy the user_id<br>
                            3. Run this SQL command:
                            <code>INSERT INTO user_roles (user_id, role, agent_id, email) VALUES ('USER_ID', 'technician', '802', 'email@example.com');</code>
                        </p>
                    </div>
                </div>
                
                <!-- Agents Tab -->
                <div class="tab-content" id="agents-tab">
                    <div class="section-header">
                        <h2>Agent Management</h2>
                        <button class="btn btn-primary" onclick="openAddAgentModal()">+ Add Agent</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Agent ID</th>
                                    <th>Assigned Users</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="agentsTableBody">
                                <tr><td colspan="3" style="text-align: center; color: var(--text-muted); padding: 40px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Clients Tab -->
                <div class="tab-content" id="clients-tab">
                    <div class="section-header">
                        <h2>Client Management</h2>
                        <button class="btn btn-primary" onclick="openAddClientModal()">+ Add Client</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Client ID</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTableBody">
                                <tr><td colspan="2" style="text-align: center; color: var(--text-muted); padding: 40px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Vendors Tab -->
                <div class="tab-content" id="vendors-tab">
                    <div class="section-header">
                        <h2>Vendor Management</h2>
                        <button class="btn btn-primary" onclick="openAddVendorModal()">+ Add Vendor</button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Vendor ID</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vendorsTableBody">
                                <tr><td colspan="2" style="text-align: center; color: var(--text-muted); padding: 40px;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Agent Modal -->
    <div class="modal" id="addAgentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Agent</h3>
            </div>
            <form id="addAgentForm">
                <div class="form-group">
                    <label class="form-label">Agent ID</label>
                    <input type="text" id="agentId" class="form-input" required placeholder="e.g., 804">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" onclick="closeAddAgentModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Agent</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Client Modal -->
    <div class="modal" id="addClientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Client</h3>
            </div>
            <form id="addClientForm">
                <div class="form-group">
                    <label class="form-label">Client ID</label>
                    <input type="text" id="clientId" class="form-input" required placeholder="e.g., AMTEK">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" onclick="closeAddClientModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Client</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Vendor Modal -->
    <div class="modal" id="addVendorModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Vendor</h3>
            </div>
            <form id="addVendorForm">
                <div class="form-group">
                    <label class="form-label">Vendor ID</label>
                    <input type="text" id="vendorId" class="form-input" required placeholder="e.g., XYZ">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-ghost" onclick="closeAddVendorModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Vendor</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            currentUser = await initAuth('manager');
            if (!currentUser) return;
            
            await Promise.all([
                loadUsers(),
                loadAgents(),
                loadClients(),
                loadVendors()
            ]);
            
            // Setup tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                });
            });
            
            // Setup forms
            document.getElementById('addAgentForm').addEventListener('submit', handleAddAgent);
            document.getElementById('addClientForm').addEventListener('submit', handleAddClient);
            document.getElementById('addVendorForm').addEventListener('submit', handleAddVendor);
            
            // Setup sidebar
            document.getElementById("hamburgerBtn").addEventListener("click", toggleSidebar);
            document.getElementById("sidebarOverlay").addEventListener("click", closeSidebar);
            document.getElementById("sidebarClose").addEventListener("click", closeSidebar);
        });
        
        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("active");
            document.getElementById("sidebarOverlay").classList.toggle("active");
            document.getElementById("hamburgerBtn").classList.toggle("active");
        }
        
        function closeSidebar() {
            document.getElementById("sidebar").classList.remove("active");
            document.getElementById("sidebarOverlay").classList.remove("active");
            document.getElementById("hamburgerBtn").classList.remove("active");
        }
        
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            
            const icons = { success: '‚úì', error: '‚úï', warning: '‚ö†', info: '‚Ñπ' };
            alert.innerHTML = `<span class="alert-icon">${icons[type] || '‚Ñπ'}</span><span>${message}</span>`;
            
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }
        
        async function loadUsers() {
            try {
                const { data, error } = await db
                    .from('user_roles')
                    .select('*')
                    .order('agent_id', { ascending: true });
                
                if (error) throw error;
                
                const tbody = document.getElementById('usersTableBody');
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted); padding: 40px;">No users found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(user => `
                    <tr>
                        <td style="font-family: var(--font-mono);">${user.agent_id || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td><span class="badge badge-${user.role}">${user.role}</span></td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8125rem;" onclick="deleteUser('${user.user_id}', '${user.email}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
                showAlert('Error loading users: ' + error.message, 'error');
            }
        }
        
        async function loadAgents() {
            try {
                const { data, error } = await db
                    .from('agents')
                    .select('agent_id')
                    .order('agent_id', { ascending: true });
                
                if (error) throw error;
                
                const { data: userCounts } = await db.from('user_roles').select('agent_id');
                
                const counts = {};
                userCounts?.forEach(u => {
                    if (u.agent_id) counts[u.agent_id] = (counts[u.agent_id] || 0) + 1;
                });
                
                const tbody = document.getElementById('agentsTableBody');
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-muted); padding: 40px;">No agents found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(agent => `
                    <tr>
                        <td style="font-family: var(--font-mono); font-weight: 600;">${agent.agent_id}</td>
                        <td>${counts[agent.agent_id] || 0} user(s)</td>
                        <td>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8125rem;" onclick="deleteAgent('${agent.agent_id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading agents:', error);
                showAlert('Error loading agents: ' + error.message, 'error');
            }
        }
        
        async function loadClients() {
            try {
                const { data, error } = await db
                    .from('clients')
                    .select('client_id')
                    .order('client_id', { ascending: true });
                
                if (error) throw error;
                
                const tbody = document.getElementById('clientsTableBody');
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--text-muted); padding: 40px;">No clients found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(client => `
                    <tr>
                        <td style="font-family: var(--font-mono); font-weight: 600;">${client.client_id}</td>
                        <td>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8125rem;" onclick="deleteClient('${client.client_id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading clients:', error);
                showAlert('Error loading clients: ' + error.message, 'error');
            }
        }
        
        async function loadVendors() {
            try {
                const { data, error } = await db
                    .from('vendors')
                    .select('vendor_id')
                    .order('vendor_id', { ascending: true });
                
                if (error) throw error;
                
                const tbody = document.getElementById('vendorsTableBody');
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--text-muted); padding: 40px;">No vendors found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(vendor => `
                    <tr>
                        <td style="font-family: var(--font-mono); font-weight: 600;">${vendor.vendor_id}</td>
                        <td>
                            <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8125rem;" onclick="deleteVendor('${vendor.vendor_id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading vendors:', error);
                showAlert('Error loading vendors: ' + error.message, 'error');
            }
        }
        
        // Modal functions
        function openAddAgentModal() {
            document.getElementById('addAgentModal').classList.add('active');
        }
        
        function closeAddAgentModal() {
            document.getElementById('addAgentModal').classList.remove('active');
            document.getElementById('addAgentForm').reset();
        }
        
        function openAddClientModal() {
            document.getElementById('addClientModal').classList.add('active');
        }
        
        function closeAddClientModal() {
            document.getElementById('addClientModal').classList.remove('active');
            document.getElementById('addClientForm').reset();
        }
        
        function openAddVendorModal() {
            document.getElementById('addVendorModal').classList.add('active');
        }
        
        function closeAddVendorModal() {
            document.getElementById('addVendorModal').classList.remove('active');
            document.getElementById('addVendorForm').reset();
        }
        
        // CRUD operations
        async function handleAddAgent(e) {
            e.preventDefault();
            const agentId = document.getElementById('agentId').value;
            
            try {
                const { error } = await db.from('agents').insert([{ agent_id: agentId }]);
                if (error) throw error;
                
                showAlert('Agent added successfully!', 'success');
                closeAddAgentModal();
                await loadAgents();
            } catch (error) {
                showAlert('Error adding agent: ' + error.message, 'error');
            }
        }
        
        async function handleAddClient(e) {
            e.preventDefault();
            const clientId = document.getElementById('clientId').value.toUpperCase();
            
            try {
                const { error } = await db.from('clients').insert([{ client_id: clientId }]);
                if (error) throw error;
                
                showAlert('Client added successfully!', 'success');
                closeAddClientModal();
                await loadClients();
            } catch (error) {
                showAlert('Error adding client: ' + error.message, 'error');
            }
        }
        
        async function handleAddVendor(e) {
            e.preventDefault();
            const vendorId = document.getElementById('vendorId').value.toUpperCase();
            
            try {
                const { error } = await db.from('vendors').insert([{ vendor_id: vendorId }]);
                if (error) throw error;
                
                showAlert('Vendor added successfully!', 'success');
                closeAddVendorModal();
                await loadVendors();
            } catch (error) {
                showAlert('Error adding vendor: ' + error.message, 'error');
            }
        }
        
        async function deleteAgent(agentId) {
            if (!confirm(`Delete agent ${agentId}? This will also delete all associated boxes, jobs, and serials.`)) return;
            
            try {
                const { error } = await db.from('agents').delete().eq('agent_id', agentId);
                if (error) throw error;
                
                showAlert('Agent deleted successfully!', 'success');
                await loadAgents();
            } catch (error) {
                showAlert('Error deleting agent: ' + error.message, 'error');
            }
        }
        
        async function deleteClient(clientId) {
            if (!confirm(`Delete client ${clientId}?`)) return;
            
            try {
                const { error } = await db.from('clients').delete().eq('client_id', clientId);
                if (error) throw error;
                
                showAlert('Client deleted successfully!', 'success');
                await loadClients();
            } catch (error) {
                showAlert('Error deleting client: ' + error.message, 'error');
            }
        }
        
        async function deleteVendor(vendorId) {
            if (!confirm(`Delete vendor ${vendorId}?`)) return;
            
            try {
                const { error } = await db.from('vendors').delete().eq('vendor_id', vendorId);
                if (error) throw error;
                
                showAlert('Vendor deleted successfully!', 'success');
                await loadVendors();
            } catch (error) {
                showAlert('Error deleting vendor: ' + error.message, 'error');
            }
        }
        
        async function deleteUser(userId, email) {
            if (!confirm(`Delete user ${email}? They will lose access to the system.`)) return;
            
            try {
                const { error } = await db.from('user_roles').delete().eq('user_id', userId);
                if (error) throw error;
                
                showAlert(`‚úì User ${email} removed.`, 'success');
                await loadUsers();
            } catch (error) {
                showAlert('Error deleting user: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
